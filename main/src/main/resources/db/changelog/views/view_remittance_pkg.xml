<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.6.xsd">

    <!-- erfan -->
    <changeSet id="erfan1" author="saeb">
<!--        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/1.sql"/>-->
        <sql splitStatements="false" stripComments="false">
            <![CDATA[
                DECLARE i INTEGER;
                BEGIN

                SELECT COUNT(*) INTO i FROM user_indexes WHERE upper(index_name) = 'IDX_DBA_REMITTANCE_DET_INVID';
                IF i = 0 THEN
                    EXECUTE IMMEDIATE 'create index IDX_DBA_REMITTANCE_DET_INVID on TBL_WARH_REMITTANCE_DETAIL (f_inventory_id)';
                END IF;

                SELECT COUNT(*) INTO i FROM user_indexes WHERE upper(index_name) = 'IDX_DBA_REMITTANCE_DESTOZINID';
                IF i = 0 THEN
                    EXECUTE IMMEDIATE 'create index IDX_DBA_REMITTANCE_DESTOZINID on TBL_WARH_REMITTANCE_DETAIL (f_destination_tozine_id)';
                END IF;

                SELECT COUNT(*) INTO i FROM user_indexes WHERE upper(index_name) = 'IDX_DBA_REMITTANCE_SRCTOZINID';
                IF i = 0 THEN
                    EXECUTE IMMEDIATE 'create index IDX_DBA_REMITTANCE_SRCTOZINID on TBL_WARH_REMITTANCE_DETAIL (f_source_tozine_id)';
                END IF;

                SELECT COUNT(*) INTO i FROM user_indexes WHERE upper(index_name) = 'IDX_DBA_REMITTANCE_UNITID';
                IF i = 0 THEN
                    EXECUTE IMMEDIATE 'create index IDX_DBA_REMITTANCE_UNITID on TBL_WARH_REMITTANCE_DETAIL (f_unit_id)';
                END IF;

                SELECT COUNT(*) INTO i FROM user_indexes WHERE upper(index_name) = 'IDX_DBA_WARHTOZIN_FADATE';
                IF i = 0 THEN
                    EXECUTE IMMEDIATE 'create index IDX_DBA_WARHTOZIN_FADATE on TBL_WARH_TOZIN(DAT)';
                END IF;
                END;
            ]]>
        </sql>
        <sql splitStatements="false" stripComments="false">
            <![CDATA[
                DECLARE
                    j INTEGER;
                BEGIN
                    SELECT
                        COUNT(*)
                    INTO j
                    FROM
                        user_tables
                    WHERE
                        upper(table_name) = 'RPRT_TB_FACT_LOGESTIC_TOZIN';

                    IF j = 0 THEN
                        EXECUTE IMMEDIATE 'create table RPRT_TB_FACT_LOGESTIC_TOZIN
                                        (
                                          dat       varchar2(10),
                                          tozine_id varchar2(60) not null,
                                          sourceid  number,
                                          targetid  number,
                                          material  number not null,
                                          wazn      number,
                                          pkg       number,
                                          is_rail   number not null,
                                          key_1     varchar2(100),
                                          dat_ym    as (substr(dat,1,6)),
                                          dat_y     as (substr(dat,1,4)),
                                          constraint pk_fact_logestic_tozin primary key (tozine_id)
                                        )'
                        ;
                    END IF;
                    SELECT
                        COUNT(*)
                    INTO j
                    FROM
                        user_indexes
                    WHERE
                        lower(index_name) = 'idx_logstictozin_key1';

                    IF j = 0 THEN
                        EXECUTE IMMEDIATE 'create index idx_logstictozin_key1 on RPRT_TB_FACT_LOGESTIC_TOZIN (key_1)';
                    END IF;
                    SELECT
                        COUNT(*)
                    INTO j
                    FROM
                        user_indexes
                    WHERE
                        lower(index_name) = 'idx_logstictozin_dat';

                    IF j = 0 THEN
                        EXECUTE IMMEDIATE 'create index idx_logstictozin_dat on RPRT_TB_FACT_LOGESTIC_TOZIN (DAT)';
                    END IF;

                                SELECT
                        COUNT(*)
                    INTO j
                    FROM
                        user_indexes
                    WHERE
                        lower(index_name) = 'idx_fn_logstictozin_dat_date';

                    IF j = 0 THEN
                        EXECUTE IMMEDIATE 'create index idx_FN_logstictozin_dat_date on RPRT_TB_FACT_LOGESTIC_TOZIN (to_date(dat, ''yyyymmdd'', ''nls_calendar=persian''))';
                    END IF;
                    SELECT
                        COUNT(*)
                    INTO j
                    FROM
                        user_indexes
                    WHERE
                        lower(index_name) = 'idx_logstictozin_srcid';

                    IF j = 0 THEN
                        EXECUTE IMMEDIATE 'create index idx_logstictozin_srcid on RPRT_TB_FACT_LOGESTIC_TOZIN (SOURCEID)';
                    END IF;
                    SELECT
                        COUNT(*)
                    INTO j
                    FROM
                        user_indexes
                    WHERE
                        lower(index_name) = 'idx_logstictozin_tgtid';

                    IF j = 0 THEN
                        EXECUTE IMMEDIATE 'create index idx_logstictozin_tgtid on RPRT_TB_FACT_LOGESTIC_TOZIN (TARGETID)';
                    END IF;
                END;
            ]]>
        </sql>
<!--        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/2_1.sql"/>-->
        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/2_2.sql"/>
        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/3_1.sql"/>
        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/3_2.sql"/>
        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/3_3.sql"/>
        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/3_4.sql"/>
<!--        <sqlFile  stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/4.sql"/>-->
<!--        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/5.sql"/>-->
<!--        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/6.sql"/>-->
        <createProcedure>
            <![CDATA[
            create or replace procedure RPRT_PR_UPDATE_FACT_LOGESTICTOZIN as
            last_date_fa varchar2(100);
            run_hour number;
            begin
            select to_number(to_char(systimestamp AT TIME ZONE 'Asia/Tehran', 'HH24')) into run_hour from dual;

            if run_hour <5  or run_hour>20 then
            execute immediate 'truncate table RPRT_TB_FACT_LOGESTIC_TOZIN';
            end if;

            select to_char(to_date(nvl(max(dat), '13900102'),'yyyymmdd', 'nls_calendar=persian')-1, 'yyyymmdd', 'nls_calendar=persian')
            into last_date_fa
            from RPRT_TB_FACT_LOGESTIC_TOZIN;

            merge into RPRT_TB_FACT_LOGESTIC_TOZIN d
            using (
            select distinct
            replace(sal_date2,'/','') dat,
            tozine_id, sourceid, targetid,
            gdscode as material,
            wazn,
            tedad as pkg,
            case when regexp_like(carno3, '[0-9]+') then 0 else 1 end as is_Rail,
            TO_CHAR(sourceid)||';'||TO_CHAR(gdscode) key_1
            from v_tozine_content_m
            where sal_date2 is not null and tozine_id not like '3-%' and targetid in (2320, 2340, 2555)
            and sal_date2 > last_date_fa) s
            on (d.tozine_id=s.tozine_id)
            when not matched then
            insert (d.dat, d.tozine_id, d.sourceid, d.targetid, d.material, d.wazn, d.pkg, d.is_rail)
            values (s.dat, s.tozine_id, s.sourceid, s.targetid, s.material, s.wazn, s.pkg, s.is_rail);

            commit;
            end;
            ]]>
        </createProcedure>
        <createProcedure>
            create or replace procedure RPRT_PR_UPDATE_REPORT as
            begin
            RPRT_PR_UPDATE_FACT_LOGESTICTOZIN;
            dbms_mview.refresh('RPRT_MV_FACT_REMITTANCE');
            dbms_mview.refresh('RPRT_MV_MATERIAL_IO_SUMMARY');
            dbms_mview.refresh('RPRT_MV_MATERIAL_SHIPMENT_SUMMARY');
            end
        </createProcedure>

<!--        <sqlFile stripComments="true" relativeToChangelogFile="true" encoding="UTF-8"  path="remittance/7.sql"/>-->
    </changeSet>
    <changeSet id="erfan222" author="saeb">
        <sql>
            CALL RPRT_PR_UPDATE_FACT_LOGESTICTOZIN();
        </sql>
    </changeSet>
    <changeSet id="erfann" author="saeb">
        <sql>select count(*) from RPRT_TB_FACT_LOGESTIC_TOZIN;</sql>
    </changeSet>


    <!-- erfan -->


    <!--     report_material_source_bandarabas-->
    <changeSet id="salkljals" author="saeb">
        <createTable tableName="REPORT_MATERIAL_SOURCE_BANDARABAS">
            <column type="NUMBER" name="ID">
                <constraints primaryKey="true" primaryKeyName="pk_REPORT_MATERIAL_SOURCE_BANDARABAS"/>
            </column>
            <column type="NUMBER" name="SOURCE_ID"/>
            <column type="VARCHAR2(255)" name="SOURCE_NAME"/>
            <column type="NUMBER" name="UNIT_ID"/>
            <column type="VARCHAR2(255)" name="UNIT_NAME"/>
            <column type="NUMBER" name="MATERIAL_ID"/>
            <column type="VARCHAR2(255)" name="MATERIAL_NAME"/>
            <column type="VARCHAR2(2000)" name="DESCRIPTION"/>
        </createTable>
    </changeSet>
    <changeSet id="INSERT_TO_REPORT_BANDARABAS_001" author="karimi">
        <sql>INSERT INTO REPORT_MATERIAL_SOURCE_BANDARABAS (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME,
            MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (8, 1021, 'خاتون‌آباد', 4, 'بسته', 10, 'کاتد لیچینگ', null)
        </sql>
        <sql>INSERT INTO REPORT_MATERIAL_SOURCE_BANDARABAS (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME,
            MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (9, 1000, 'مجتمع مس سرچشمه', 4, 'بسته', 10, 'کاتد لیچینگ',
            null)
        </sql>
        <sql>INSERT INTO REPORT_MATERIAL_SOURCE_BANDARABAS (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME,
            MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (10, 1000, 'مجتمع مس سرچشمه', 4, 'بسته', 11, 'کاتد
            پالایشگاه', null)
        </sql>
        <sql>INSERT INTO REPORT_MATERIAL_SOURCE_BANDARABAS (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME,
            MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (11, 1021, 'خاتون‌آباد', 4, 'بسته', 11, 'کاتد پالایشگاه',
            null)
        </sql>
        <sql>INSERT INTO REPORT_MATERIAL_SOURCE_BANDARABAS (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME,
            MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (12, 1000, 'مجتمع مس سرچشمه', 6, 'فله', 8, 'کنسانتره', null)
        </sql>
        <sql>INSERT INTO REPORT_MATERIAL_SOURCE_BANDARABAS (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME,
            MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (13, 1541, 'مجتمع مس سونگون', 6, 'فله', 8, 'کنسانتره', null)
        </sql>
        <sql>INSERT INTO REPORT_MATERIAL_SOURCE_BANDARABAS (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME,
            MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (14, 1021, 'خاتون‌آباد', 1, 'بشکه', 97, 'اکسید مولیبدن',
            null)
        </sql>
    </changeSet>
    <changeSet id="sadlkljals1" author="saeb">
        <sql>
            MERGE INTO REPORT_MATERIAL_SOURCE_BANDARABAS d
            USING (SELECT 15 AS ID FROM dual) s ON (d.ID = s.ID)
            WHEN NOT MATCHED THEN INSERT (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME, MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (15, 1000, 'مجتمع مس سرچشمه', 6, 'فله', 82, 'ته پاتيل كنورتور', null)
        </sql>
        <sql>
            MERGE INTO REPORT_MATERIAL_SOURCE_BANDARABAS d
            USING (SELECT 16 AS ID FROM dual) s ON (d.ID = s.ID)
            WHEN NOT MATCHED THEN INSERT (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME, MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (16, 1021, 'خاتون‌آباد', 6, 'فله', 82, 'ته پاتيل كنورتور', null)
        </sql>
        <sql>
            MERGE INTO REPORT_MATERIAL_SOURCE_BANDARABAS d
            USING (SELECT 17 AS ID FROM dual) s ON (d.ID = s.ID)
            WHEN NOT MATCHED THEN INSERT (ID, SOURCE_ID, SOURCE_NAME, UNIT_ID, UNIT_NAME, MATERIAL_ID, MATERIAL_NAME, DESCRIPTION) VALUES (17, 1000, 'مجتمع مس سرچشمه', 6, 'فله', 1, 'مفتول مسي 8ميليمتري', null)
        </sql>
    </changeSet>

    <!--     view_remittanceDetails2555-->

    <changeSet author="saebm" id="reasdasdasdza_0sssss05">
        <createView viewName="view_remittanceDetails2555" replaceIfExists="true">
            <![CDATA[
                 select rdetail.id                            as rd,
       inventory.F_MATERIAL_ITEM_ID          as material,
       inventory.id                          as inventory,
       nvl(dtozin.SOURCEID, stozin.SOURCEID) as source,
       nvl(dtozin.TARGETID, stozin.TARGETID) as target,
       nvl(dtozin.WAZN, stozin.WAZN)         as wazn,
       nvl(dtozin.DAT, stozin.DAT)           as dat,
       nvl(dtozin.id, stozin.id)             as tznid,
       nvl(dtozin.TOZINE_ID, stozin.TOZINE_ID)             as TOZINE_ID,
       dtozin.TOZINE_ID as dtozin,
       stozin.TOZINE_ID as stozin,
       rdetail.N_AMOUNT                      as amount
from TBL_WARH_REMITTANCE_DETAIL rdetail
         left join TBL_WARH_TOZIN dtozin on dtozin.ID = rdetail.F_DESTINATION_TOZINE_ID
         left join TBL_WARH_TOZIN stozin on rdetail.F_SOURCE_TOZINE_ID = stozin.ID
         left join TBL_WARH_INVENTORY inventory on rdetail.F_INVENTORY_ID = inventory.ID
where nvl(dtozin.SOURCEID, stozin.SOURCEID) in (2320, 2340, 2555)
   or nvl(dtozin.TARGETID, stozin.TARGETID) in (2320, 2340, 2555)
order by dat
			]]>
        </createView>
    </changeSet>


    <changeSet author="saebm" id="reasdasdassadasddza_0sssss05">
        <createView viewName="view_remittanceDetails2555" replaceIfExists="true">
            <![CDATA[
    select rdetail.id                            as rd,
       inventory.F_MATERIAL_ITEM_ID          as material,
       inventory.id                          as inventory,
       nvl(dtozin.SOURCEID, stozin.SOURCEID) as source,
       nvl(dtozin.TARGETID, stozin.TARGETID) as target,
       nvl(dtozin.WAZN, stozin.WAZN)         as wazn,
       nvl(dtozin.DAT, stozin.DAT)           as dat,
       nvl(dtozin.id, stozin.id)             as tznid,
       nvl(dtozin.TOZINE_ID, stozin.TOZINE_ID)             as TOZINE_ID,
       dtozin.TOZINE_ID as dtozin,
       stozin.TOZINE_ID as stozin,
       rdetail.N_AMOUNT                      as amount,
       TMI.C_NAME_FA as unit
from TBL_WARH_REMITTANCE_DETAIL rdetail
         left join TBL_WARH_TOZIN dtozin on dtozin.ID = rdetail.F_DESTINATION_TOZINE_ID
         left join TBL_WARH_TOZIN stozin on rdetail.F_SOURCE_TOZINE_ID = stozin.ID
         left join TBL_WARH_INVENTORY inventory on rdetail.F_INVENTORY_ID = inventory.ID
        left join TBL_UNIT TMI on rdetail.F_UNIT_ID = TMI.ID
where nvl(dtozin.SOURCEID, stozin.SOURCEID) in (2320, 2340, 2555)
   or nvl(dtozin.TARGETID, stozin.TARGETID) in (2320, 2340, 2555)
order by dat



			]]>
        </createView>
    </changeSet>

    <!--    view_dat_source_material-->

    <changeSet author="saebm" id="reasdasdassammmmdasddza_0sssss05">
        <createView viewName="view_dat_source_material" replaceIfExists="true">
            <![CDATA[
   select dd.date__ as dat, ms.source as source, ms.material as material
from (
         select TO_CHAR(
                                (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                 from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                'nls_calendar=persian') as date__
         from dual
         connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                     from TBL_WARH_TOZIN t) +
                    LEVEL - 1 < CURRENT_DATE) dd,
     (select material, source
      from view_remittanceDetails2555
      where source not in (2320, 2340, 2555)
      group by material, source) ms
order by dd.date__ asc, ms.source, ms.material


			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reasdasdassamammdasddza_0sssss05">
        <createView viewName="view_dat_source_material" replaceIfExists="true">
            <![CDATA[
 select dd.date__ as dat, ms.source as source, ms.material as material,ms.UNIT
from (
         select TO_CHAR(
                                (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                 from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                'nls_calendar=persian') as date__
         from dual
         connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                     from TBL_WARH_TOZIN t) +
                    LEVEL - 1 < CURRENT_DATE) dd,
     (select material, source,max(UNIT) as unit
      from view_remittanceDetails2555
      where source not in (2320, 2340, 2555)
      group by material, source) ms
order by dd.date__ asc, ms.source, ms.material


			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reas_0sssss05">
        <createView viewName="view_dat_source_material" replaceIfExists="true">
            <![CDATA[
 select dd.date__ as dat, ms.source as source, ms.material as material,ms.UNIT
from (
         select TO_CHAR(
                                (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                 from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                'nls_calendar=persian') as date__
         from dual
         connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                     from TBL_WARH_TOZIN t) +
                    LEVEL - 1 < CURRENT_DATE) dd,
     (select material, source,max(UNIT) as unit
      from view_remittanceDetails2555
      where source not in (2320, 2340, 2555)
      group by material, source) ms
order by dd.date__ asc, ms.source, ms.material


			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reas_kssss05">
        <createView viewName="view_dat_source_material" replaceIfExists="true">
            <![CDATA[
 select dd.date__ as dat,vv.SOURCE,vv.MATERIAL,vv.unit from (
           select to_char(to_date('13990101', 'yyyymmdd', 'nls_calendar=persian') + LEVEL - 1, 'yyyymmdd',
                          'nls_calendar=persian') as date__
           from dual
           connect by to_date('13990101', 'yyyymmdd', 'nls_calendar=persian') + LEVEL <= current_date
       ) dd,
    (select MATERIAL,SOURCE,max(UNIT) as unit from VIEW_REMITTANCEDETAILS2555
           where SOURCE not in (2320,2340,2555)
           group by MATERIAL,SOURCE) vv


			]]>
        </createView>
    </changeSet>

    <changeSet author="saebm" id="reass05">
        <createView viewName="view_dat_source_material" replaceIfExists="true">
            <![CDATA[
 select dd.date__ as dat, vv.SOURCE_ID SOURCE,
        vv.SOURCE_NAME,
       vv.MATERIAL_ID MATERIAL,
       vv.MATERIAL_NAME,
       vv.UNIT_NAME unit
from (
         select to_char(to_date('13990101', 'yyyymmdd', 'nls_calendar=persian') + LEVEL - 1, 'yyyymmdd',
                        'nls_calendar=persian') as date__
         from dual
         connect by to_date('13990101', 'yyyymmdd', 'nls_calendar=persian') + LEVEL <= current_date
     ) dd,
     (select * from REPORT_MATERIAL_SOURCE_BANDARABAS) vv
order by dd.date__ desc ,vv.MATERIAL_ID,vv.SOURCE_ID







			]]>
        </createView>
    </changeSet>


    <!--    view_remittance_pkg-->

    <changeSet author="saebm" id="reasdasdasdza_0sss05">
        <createView viewName="view_remittance_pkg" replaceIfExists="true">
            <![CDATA[
                  select rows_.dat,
                         rows_.source,
                         rows_.material,
                         sum(case
                                 when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then 1
                                 else 0 end) as in_pkg_day,
                         sum(case
                                 when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                                     and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6)
                                     then 1
                                 else 0 end) as in_pkg_month,
                         sum(case
                                 when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                                     and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4)
                                     then 1
                                 else 0 end) as in_pkg_year,

                         sum(case
                                 when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
                                 else 0 end) as in_amount_day,
                         sum(case
                                 when rows_.source = vrD2555.SOURCE and vrD2555.DAT<=rows_.dat
                                     and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6) then vrD2555.AMOUNT
                                 else 0 end) as in_amount_month,
                         sum(case
                                 when rows_.source = vrD2555.SOURCE and vrD2555.DAT<=rows_.dat
                                     and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4) then vrD2555.AMOUNT
                                 else 0 end) as in_amount_year,

                         sum(case
                                 when vrD2555.source in (2320,2340,2555)and rows_.dat = vrD2555.DAT then 1
                                 else 0 end) as out_pkg_day,
                         sum(case
                                 when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                                     and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6)
                                     then 1
                                 else 0 end) as out_pkg_month,
                         sum(case
                                 when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                                     and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4)
                                     then 1
                                 else 0 end) as out_pkg_year,

                         sum(case
                                 when vrD2555.source in (2320,2340,2555)and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
                                 else 0 end) as out_amount_day,
                         sum(case
                                 when vrD2555.source in (2320,2340,2555)and vrD2555.DAT<=rows_.dat
                                     and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6) then vrD2555.AMOUNT
                                 else 0 end) as out_amount_month,
                         sum(case
                                 when vrD2555.source in (2320,2340,2555)and vrD2555.DAT<=rows_.dat
                                     and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4) then vrD2555.AMOUNT
                                 else 0 end) as out_amount_year,
                         sum(case
                                 when rows_.source = vrD2555.SOURCE then 1
                                 else -1 end) as remained_pkg,
                         sum(case
                                 when rows_.source = vrD2555.SOURCE then vrD2555.AMOUNT
                                 else -vrD2555.AMOUNT end) as remained_amount
                  from (
                           select dd.date__ as dat, ms.source as source, ms.material as material
                           from (
                                    select TO_CHAR((select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                                    from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                                   'nls_calendar=persian') as date__
                                    from dual
                                    connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                                from TBL_WARH_TOZIN t) +
                                               LEVEL - 1 < CURRENT_DATE) dd,
                                (select material, source
                                 from view_remittanceDetails2555
                                 where source not in (2320, 2340, 2555)
                                 group by material, source) ms
                           order by dd.date__ asc, ms.source, ms.material) rows_
                           left join view_remittanceDetails2555 vrD2555
                                     on rows_.material = vrD2555.material and   vrD2555.dat <=rows_.dat
                                         and (
                                                (rows_.source = vrD2555.source and vrD2555.target in (2320, 2340, 2555))
                                                or
                                                (vrD2555.source in (2320, 2340, 2555) and vrD2555.inventory in (
                                                    select vrD25552.inventory
                                                    from view_remittanceDetails2555 vrD25552
                                                    where vrD25552.source = rows_.source
                                                      and vrD25552.dat <= rows_.dat
                                                      and vrD25552.material = rows_.material
                                                ))
                                            )
                  group by rows_.dat, rows_.source, rows_.material
                  order by rows_.dat desc, rows_.source, rows_.material
			]]>
        </createView>
    </changeSet>

    <changeSet author="saebm" id="reasdasdasdza_0sss0ds5">
        <createView viewName="view_remittance_pkg" replaceIfExists="true">
            <![CDATA[
                select rows_.dat,
       rows_.source,
       rows_.material,
       max(vrD2555.unit) as unit,
       sum(case
               when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then 1
               else 0 end) as in_pkg_day,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6)
                   then 1
               else 0 end) as in_pkg_month,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4)
                   then 1
               else 0 end) as in_pkg_year,

       sum(case
               when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
               else 0 end) as in_amount_day,
       sum(case
               when rows_.source = vrD2555.SOURCE and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6) then vrD2555.AMOUNT
               else 0 end) as in_amount_month,
       sum(case
               when rows_.source = vrD2555.SOURCE and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4) then vrD2555.AMOUNT
               else 0 end) as in_amount_year,

       sum(case
               when vrD2555.source in (2320,2340,2555)and rows_.dat = vrD2555.DAT then 1
               else 0 end) as out_pkg_day,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6)
                   then 1
               else 0 end) as out_pkg_month,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4)
                   then 1
               else 0 end) as out_pkg_year,

       sum(case
               when vrD2555.source in (2320,2340,2555)and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
               else 0 end) as out_amount_day,
       sum(case
               when vrD2555.source in (2320,2340,2555)and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6) then vrD2555.AMOUNT
               else 0 end) as out_amount_month,
       sum(case
               when vrD2555.source in (2320,2340,2555)and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4) then vrD2555.AMOUNT
               else 0 end) as out_amount_year,
       sum(case
               when rows_.source = vrD2555.SOURCE then 1
               else -1 end) as remained_pkg,
       sum(case
               when rows_.source = vrD2555.SOURCE then vrD2555.AMOUNT
               else -vrD2555.AMOUNT end) as remained_amount
from (
         select dd.date__ as dat, ms.source as source, ms.material as material
         from (
                  select TO_CHAR((select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                  from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                 'nls_calendar=persian') as date__
                  from dual
                  connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                              from TBL_WARH_TOZIN t) +
                             LEVEL - 1 < CURRENT_DATE) dd,
              (select material, source
               from view_remittanceDetails2555
               where source not in (2320, 2340, 2555)
               group by material, source) ms
         order by dd.date__ asc, ms.source, ms.material) rows_
         left join view_remittanceDetails2555 vrD2555
                   on rows_.material = vrD2555.material and   vrD2555.dat <=rows_.dat
                       and (
                              (rows_.source = vrD2555.source and vrD2555.target in (2320, 2340, 2555))
                              or
                              (vrD2555.source in (2320, 2340, 2555) and vrD2555.inventory in (
                                  select vrD25552.inventory
                                  from view_remittanceDetails2555 vrD25552
                                  where vrD25552.source = rows_.source
                                    and vrD25552.dat <= rows_.dat
                                    and vrD25552.material = rows_.material
                              ))
                          )
group by rows_.dat, rows_.source, rows_.material
order by rows_.dat desc, rows_.source, rows_.material

			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reasdassssdasdza_0sss0ds5">
        <createView viewName="view_remittance_pkg" replaceIfExists="true">
            <![CDATA[
              select rows_.dat,
       rows_.source,
       rows_.material,
       max(vrD2555.unit) as unit,
       sum(case
               when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then 1
               else 0 end) as in_pkg_day,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6)
                   then 1
               else 0 end) as in_pkg_month,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4)
                   then 1
               else 0 end) as in_pkg_year,

       sum(case
               when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
               else 0 end) as in_amount_day,
       sum(case
               when rows_.source = vrD2555.SOURCE and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6) then vrD2555.AMOUNT
               else 0 end) as in_amount_month,
       sum(case
               when rows_.source = vrD2555.SOURCE and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4) then vrD2555.AMOUNT
               else 0 end) as in_amount_year,

       sum(case
               when vrD2555.source in (2320,2340,2555)and rows_.dat = vrD2555.DAT then 1
               else 0 end) as out_pkg_day,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6)
                   then 1
               else 0 end) as out_pkg_month,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4)
                   then 1
               else 0 end) as out_pkg_year,

       sum(case
               when vrD2555.source in (2320,2340,2555)and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
               else 0 end) as out_amount_day,
       sum(case
               when vrD2555.source in (2320,2340,2555)and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,6)=substr(rows_.DAT,0,6) then vrD2555.AMOUNT
               else 0 end) as out_amount_month,
       sum(case
               when vrD2555.source in (2320,2340,2555)and vrD2555.DAT<=rows_.dat
                   and substr(vrD2555.DAT,0,4)=substr(rows_.DAT,0,4) then vrD2555.AMOUNT
               else 0 end) as out_amount_year,
       sum(case
               when rows_.source = vrD2555.SOURCE then 1
           when vrD2555.source in (2320, 2340, 2555) then -1
               else 0 end) as remained_pkg,
       sum(case
               when rows_.source = vrD2555.SOURCE then vrD2555.AMOUNT
               else -vrD2555.AMOUNT end) as remained_amount
from (
         select dd.date__ as dat, ms.source as source, ms.material as material
         from (
                  select TO_CHAR((select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                  from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                 'nls_calendar=persian') as date__
                  from dual
                  connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                              from TBL_WARH_TOZIN t) +
                             LEVEL - 1 < CURRENT_DATE) dd,
              (select material, source
               from view_remittanceDetails2555
               where source not in (2320, 2340, 2555)
               group by material, source) ms
         order by dd.date__ asc, ms.source, ms.material) rows_
         left join view_remittanceDetails2555 vrD2555
                   on rows_.material = vrD2555.material and   vrD2555.dat <=rows_.dat
                       and (
                              (rows_.source = vrD2555.source and vrD2555.target in (2320, 2340, 2555))
                              or
                              (vrD2555.source in (2320, 2340, 2555) and vrD2555.inventory in (
                                  select vrD25552.inventory
                                  from view_remittanceDetails2555 vrD25552
                                  where vrD25552.source = rows_.source
                                    and vrD25552.dat <= rows_.dat
                                    and vrD25552.material = rows_.material
                              ))
                          )
group by rows_.dat, rows_.source, rows_.material
order by rows_.dat desc, rows_.source, rows_.material



			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reaz5">
        <createView viewName="view_remittance_pkg" replaceIfExists="true">
            <![CDATA[
             select rows_.dat,
       rows_.source,
       rows_.material,
       rows_.UNIT,
       sum(case
               when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then 1
               else 0 end)               as in_pkg_day,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT <= rows_.dat
                   and substr(vrD2555.DAT, 0, 6) = substr(rows_.DAT, 0, 6)
                   then 1
               else 0 end)               as in_pkg_month,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT <= rows_.dat
                   and substr(vrD2555.DAT, 0, 4) = substr(rows_.DAT, 0, 4)
                   then 1
               else 0 end)               as in_pkg_year,

       sum(case
               when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
               else 0 end)               as in_amount_day,
       sum(case
               when rows_.source = vrD2555.SOURCE and vrD2555.DAT <= rows_.dat
                   and substr(vrD2555.DAT, 0, 6) = substr(rows_.DAT, 0, 6) then vrD2555.AMOUNT
               else 0 end)               as in_amount_month,
       sum(case
               when rows_.source = vrD2555.SOURCE and vrD2555.DAT <= rows_.dat
                   and substr(vrD2555.DAT, 0, 4) = substr(rows_.DAT, 0, 4) then vrD2555.AMOUNT
               else 0 end)               as in_amount_year,

       sum(case
               when vrD2555.source in (2320, 2340, 2555) and rows_.dat = vrD2555.DAT then 1
               else 0 end)               as out_pkg_day,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT <= rows_.dat
                   and substr(vrD2555.DAT, 0, 6) = substr(rows_.DAT, 0, 6)
                   then 1
               else 0 end)               as out_pkg_month,
       sum(case
               when vrD2555.SOURCE = rows_.source and vrD2555.DAT <= rows_.dat
                   and substr(vrD2555.DAT, 0, 4) = substr(rows_.DAT, 0, 4)
                   then 1
               else 0 end)               as out_pkg_year,

       sum(case
               when vrD2555.source in (2320, 2340, 2555) and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
               else 0 end)               as out_amount_day,
       sum(case
               when vrD2555.source in (2320, 2340, 2555) and vrD2555.DAT <= rows_.dat
                   and substr(vrD2555.DAT, 0, 6) = substr(rows_.DAT, 0, 6) then vrD2555.AMOUNT
               else 0 end)               as out_amount_month,
       sum(case
               when vrD2555.source in (2320, 2340, 2555) and vrD2555.DAT <= rows_.dat
                   and substr(vrD2555.DAT, 0, 4) = substr(rows_.DAT, 0, 4) then vrD2555.AMOUNT
               else 0 end)               as out_amount_year,
       sum(case
               when rows_.source = vrD2555.SOURCE then 1
               when vrD2555.source in (2320, 2340, 2555) then -1
               else 0 end)               as remained_pkg,
       sum(case
               when rows_.source = vrD2555.SOURCE then vrD2555.AMOUNT
               else -vrD2555.AMOUNT end) as remained_amount
from VIEW_DAT_SOURCE_MATERIAL rows_
         left join view_remittanceDetails2555 vrD2555
                   on rows_.material = vrD2555.material and vrD2555.dat <= rows_.dat
                       and (
                              (rows_.source = vrD2555.source and vrD2555.target in (2320, 2340, 2555))
                              or
                              (vrD2555.source in (2320, 2340, 2555) and vrD2555.inventory in (
                                  select vrD25552.inventory
                                  from view_remittanceDetails2555 vrD25552
                                  where vrD25552.source = rows_.source
                                    and vrD25552.dat <= rows_.dat
                                    and vrD25552.material = rows_.material
                              ))
                          )
group by rows_.dat, rows_.source, rows_.material, rows_.UNIT
order by rows_.dat desc, rows_.source, rows_.material



			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reasz5yes">
        <createView viewName="view_remittance_pkg" replaceIfExists="true">
            <![CDATA[
             with daily as (
    select rows_.dat,
           rows_.source,
           rows_.material,
           rows_.UNIT,
           sum(case
                   when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then 1
                   else 0 end) as in_pkg_day,

           sum(case
                   when rows_.source = vrD2555.SOURCE and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
                   else 0 end) as in_amount_day,

           sum(case
                   when vrD2555.source in (2320, 2340, 2555) and rows_.dat = vrD2555.DAT then 1
                   else 0 end) as out_pkg_day,


           sum(case
                   when vrD2555.source in (2320, 2340, 2555) and rows_.dat = vrD2555.DAT then vrD2555.AMOUNT
                   else 0 end) as out_amount_day


    from VIEW_DAT_SOURCE_MATERIAL rows_
             left join view_remittanceDetails2555 vrD2555
                       on rows_.material = vrD2555.material and vrD2555.dat = rows_.dat
                           and (
                                  (rows_.source = vrD2555.source and vrD2555.target in (2320, 2340, 2555))
                                  or
                                  (vrD2555.source in (2320, 2340, 2555) and vrD2555.inventory in (
                                      select vrD25552.inventory
                                      from view_remittanceDetails2555 vrD25552
                                      where vrD25552.source = rows_.source
                                        and vrD25552.dat = rows_.dat
                                        and vrD25552.material = rows_.material
                                  ))
                              )
    group by rows_.dat, rows_.source, rows_.material, rows_.UNIT
    order by rows_.dat desc, rows_.source, rows_.material
),
     monthly as (select d.DAT,
                        d.SOURCE,
                        d.MATERIAL,
                        d.UNIT,
                        d.in_pkg_day,
                        d.in_amount_day,
                        d.out_pkg_day,
                        d.out_amount_day,
                        sum(d2.in_amount_day)  in_amount_month,
                        sum(d2.in_pkg_day)     in_pkg_month,
                        sum(d2.out_amount_day) out_amount_month,
                        sum(d2.out_pkg_day)    out_pkg_month

                 from daily d
                          left join daily d2
                                    on d.MATERIAL = d2.MATERIAL and d.SOURCE = d2.SOURCE and
                                       substr(d.DAT, 0, 6) = substr(d2.DAT, 0, 6)
                 group by d.DAT, d.SOURCE, d.MATERIAL, d.UNIT, d.in_pkg_day, d.in_amount_day, d.out_pkg_day,
                          d.out_amount_day
     ),
     year as (
         select m.DAT,
                m.SOURCE,
                m.MATERIAL,
                m.UNIT,
                m.in_pkg_day,
                m.in_amount_day,
                m.out_pkg_day,
                m.out_amount_day,
                m.in_amount_month,
                m.in_pkg_month,
                m.out_amount_month,
                m.out_pkg_month,
                sum(m2.in_amount_month)  in_amount_year,
                sum(m2.in_pkg_month)     in_pkg_year,
                sum(m2.out_amount_month) out_amount_year,
                sum(m2.out_pkg_month)    out_pkg_year
         from monthly m
                  left join monthly m2
                            on m.MATERIAL = m2.MATERIAL and m.SOURCE = m2.SOURCE and
                               substr(m.DAT, 0, 4) = substr(m2.DAT, 0, 4)
         group by m.DAT, m.SOURCE, m.MATERIAL, m.UNIT, m.in_pkg_day, m.in_amount_day, m.out_pkg_day, m.out_amount_day,
                  m.in_amount_month, m.in_pkg_month, m.out_amount_month, m.out_pkg_month)
select y.DAT,
       y.SOURCE,
       y.MATERIAL,
       y.UNIT,
       y.in_pkg_day,
       y.in_amount_day,
       y.out_pkg_day,
       y.out_amount_day,
       y.in_amount_month,
       y.in_pkg_month,
       y.out_amount_month,
       y.out_pkg_month,
       y.in_amount_year,
       y.in_pkg_year,
       y.out_amount_year,
       y.out_pkg_year,
       sum(y2.in_pkg_year) - sum(y2.out_pkg_year)       remained_pkg,
       sum(y2.in_amount_year) - sum(y2.out_amount_year) remained_amount
from year y
         left join year y2 on y.MATERIAL = y2.MATERIAL and y.SOURCE = y2.SOURCE
group by y.DAT, y.SOURCE, y.MATERIAL, y.UNIT, y.in_pkg_day, y.in_amount_day, y.out_pkg_day, y.out_amount_day,
         y.in_amount_month, y.in_pkg_month, y.out_amount_month, y.out_pkg_month, y.in_amount_year, y.in_pkg_year,
         y.out_amount_year, y.out_pkg_year




			]]>
        </createView>
    </changeSet>

    <!--    view_remittance_weight-->

    <changeSet author="saebm" id="reasdasdasdsza_0sssss05">
        <createView viewName="view_remittance_weight" replaceIfExists="true">
            <![CDATA[
                                   select dat,
                         source,
                         material,
                         sum(income_weight_day)   as income_weight_day,
                         sum(income_weight_month) as income_weight_month,
                         sum(income_weight_year)  as income_weight_year,
                         sum(out_weight_day)      as out_weight_day,
                         sum(out_weight_month)    as out_weight_month,
                         sum(out_weight_year)     as out_weight_year,
                         sum(remained_weight)     as remained_weight
                  from (
                           select rows_.dat,
                                  rows_.source,
                                  rows_.material,
                                  vrD2555.TZNID,
                                  sum(case
                                          when vrD2555.SOURCE = rows_.source and vrD2555.dat = rows_.dat
                                              then vrD2555.WAZN
                                          else 0 end)
                                      / case
                                            when sum(case
                                                         when vrD2555.SOURCE = rows_.source and vrD2555.dat = rows_.dat
                                                             then 1
                                                         else 0 end) > 0
                                                then sum(case
                                                             when vrD2555.SOURCE = rows_.source and vrD2555.dat = rows_.dat
                                                                 then 1
                                                             else 0 end)
                                            else 1 end as income_weight_day,


                                  sum(case
                                          when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat and
                                               substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6) then vrD2555.WAZN
                                          else 0 end)
                                      / case
                                            when sum(case
                                                         when vrD2555.SOURCE = rows_.source and
                                                              vrD2555.dat <= rows_.dat and
                                                              substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6) then 1
                                                         else 0 end) > 0
                                                then sum(case
                                                             when vrD2555.SOURCE = rows_.source and
                                                                  vrD2555.dat <= rows_.dat and
                                                                  substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6)
                                                                 then 1
                                                             else 0 end)
                                            else 1 end as income_weight_month,

                                  sum(case
                                          when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat and
                                               substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4) then vrD2555.WAZN
                                          else 0 end)
                                      / case
                                            when sum(case
                                                         when vrD2555.SOURCE = rows_.source and
                                                              vrD2555.dat <= rows_.dat and
                                                              substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4) then 1
                                                         else 0 end) > 0
                                                then sum(case
                                                             when vrD2555.SOURCE = rows_.source and
                                                                  vrD2555.dat <= rows_.dat and
                                                                  substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4)
                                                                 then 1
                                                             else 0 end)
                                            else 1 end as income_weight_year,

                                  sum(case
                                          when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat = rows_.dat
                                              then vrD2555.WAZN
                                          else 0 end)
                                      / case
                                            when sum(case
                                                         when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat = rows_.dat
                                                             then 1
                                                         else 0 end) > 0
                                                then sum(case
                                                             when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat = rows_.dat
                                                                 then 1
                                                             else 0 end)
                                            else 1 end as out_weight_day,
                                  sum(case
                                          when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat and
                                               substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6) then vrD2555.WAZN
                                          else 0 end)
                                      / case
                                            when sum(case
                                                         when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                              vrD2555.dat <= rows_.dat and
                                                              substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6) then 1
                                                         else 0 end) > 0
                                                then sum(case
                                                             when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                                  vrD2555.dat <= rows_.dat and
                                                                  substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6)
                                                                 then 1
                                                             else 0 end)
                                            else 1 end as out_weight_month,

                                  sum(case
                                          when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat and
                                               substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4) then vrD2555.WAZN
                                          else 0 end)
                                      / case
                                            when sum(case
                                                         when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                              vrD2555.dat <= rows_.dat and
                                                              substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4) then 1
                                                         else 0 end) > 0
                                                then sum(case
                                                             when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                                  vrD2555.dat <= rows_.dat and
                                                                  substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4)
                                                                 then 1
                                                             else 0 end)
                                            else 1 end as out_weight_year,
--                        sum (case when vrD2555.SOURCE=rows_.source then )


                                  sum(case
                                          when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat
                                              then vrD2555.WAZN
                                          else 0 end)
                                      / case
                                            when sum(case
                                                         when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat
                                                             then 1
                                                         else 0 end) > 0
                                                then sum(case
                                                             when vrD2555.SOURCE = rows_.source and
                                                                  vrD2555.dat <= rows_.dat then 1
                                                             else 0 end)
                                            else 1 end -
                                  sum(case
                                          when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat
                                              then vrD2555.WAZN
                                          else 0 end)
                                      / case
                                            when sum(case
                                                         when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat
                                                             then 1
                                                         else 0 end) > 0
                                                then sum(case
                                                             when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                                  vrD2555.dat <= rows_.dat then 1
                                                             else 0 end)
                                            else 1 end as remained_weight

                           from (
                                    select dd.date__ as dat, ms.source as source, ms.material as material
                                    from (
                                             select TO_CHAR(
                                                                    (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                                                     from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                                                    'nls_calendar=persian') as date__
                                             from dual
                                             connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                                         from TBL_WARH_TOZIN t) +
                                                        LEVEL - 1 < CURRENT_DATE) dd,
                                         (select material, source
                                          from view_remittanceDetails2555
                                          where source not in (2320, 2340, 2555)
                                          group by material, source) ms
                                    order by dd.date__ asc, ms.source, ms.material) rows_
                                    left join view_remittanceDetails2555 vrD2555
                                              on rows_.material = vrD2555.material and vrD2555.dat <= rows_.dat
                                                  and (
                                                         (rows_.source = vrD2555.source and vrD2555.target in (2320, 2340, 2555))
                                                         or
                                                         (vrD2555.source in (2320, 2340, 2555) and
                                                          vrD2555.inventory in (
                                                              select vrD25552.inventory
                                                              from view_remittanceDetails2555 vrD25552
                                                              where vrD25552.source = rows_.source
                                                                and vrD25552.dat <= rows_.dat
                                                                and vrD25552.material = rows_.material
                                                          ))
                                                     )
--                 where rows_.dat=13981112 and rows_.MATERIAL=8
                           group by rows_.dat, rows_.source, rows_.material, vrD2555.TZNID
                           order by rows_.dat desc, rows_.source, rows_.material
                       )
-- where material=8 and (income_weight_day>0 or out_weight_day>0)
                  group by dat, source, material
                  order by dat desc, source, material










			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reaswwwdsssssasdasytrdsza_0ssjjjsss05">
        <createView viewName="view_remittance_weight" replaceIfExists="true">
            <![CDATA[

with vw0 as (select vw.dat,
                    vw.source,
                    vw.material,
                    case when sum(vrp.REMAINED_PKG) = 0 then sum(0 - vw.remained_weight) else 0 end as tadil,
                    sum(vw.income_weight_day)                                                       as income_weight_day,
                    sum(vw.income_weight_month)                                                     as income_weight_month,
                    sum(vw.income_weight_year)                                                      as income_weight_year,
                    sum(vw.out_weight_day)                                                          as out_weight_day,
                    sum(vw.out_weight_month)                                                        as out_weight_month,
                    sum(vw.out_weight_year)                                                         as out_weight_year,
                    sum(vw.remained_weight)                                                         as remained_weight
             from (
                      select rows_.dat,
                             rows_.source,
                             rows_.material,
                             vrD2555.TZNID,
                             sum(case
                                     when vrD2555.SOURCE = rows_.source and vrD2555.dat = rows_.dat
                                         then vrD2555.WAZN
                                     else 0 end)
                                 / case
                                       when sum(case
                                                    when vrD2555.SOURCE = rows_.source and vrD2555.dat = rows_.dat
                                                        then 1
                                                    else 0 end) > 0
                                           then sum(case
                                                        when vrD2555.SOURCE = rows_.source and vrD2555.dat = rows_.dat
                                                            then 1
                                                        else 0 end)
                                       else 1 end as income_weight_day,


                             sum(case
                                     when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat and
                                          substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6) then vrD2555.WAZN
                                     else 0 end)
                                 / case
                                       when sum(case
                                                    when vrD2555.SOURCE = rows_.source and
                                                         vrD2555.dat <= rows_.dat and
                                                         substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6) then 1
                                                    else 0 end) > 0
                                           then sum(case
                                                        when vrD2555.SOURCE = rows_.source and
                                                             vrD2555.dat <= rows_.dat and
                                                             substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6)
                                                            then 1
                                                        else 0 end)
                                       else 1 end as income_weight_month,

                             sum(case
                                     when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat and
                                          substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4) then vrD2555.WAZN
                                     else 0 end)
                                 / case
                                       when sum(case
                                                    when vrD2555.SOURCE = rows_.source and
                                                         vrD2555.dat <= rows_.dat and
                                                         substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4) then 1
                                                    else 0 end) > 0
                                           then sum(case
                                                        when vrD2555.SOURCE = rows_.source and
                                                             vrD2555.dat <= rows_.dat and
                                                             substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4)
                                                            then 1
                                                        else 0 end)
                                       else 1 end as income_weight_year,

                             sum(case
                                     when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat = rows_.dat
                                         then vrD2555.WAZN
                                     else 0 end)
                                 / case
                                       when sum(case
                                                    when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat = rows_.dat
                                                        then 1
                                                    else 0 end) > 0
                                           then sum(case
                                                        when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat = rows_.dat
                                                            then 1
                                                        else 0 end)
                                       else 1 end as out_weight_day,
                             sum(case
                                     when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat and
                                          substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6) then vrD2555.WAZN
                                     else 0 end)
                                 / case
                                       when sum(case
                                                    when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                         vrD2555.dat <= rows_.dat and
                                                         substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6) then 1
                                                    else 0 end) > 0
                                           then sum(case
                                                        when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                             vrD2555.dat <= rows_.dat and
                                                             substr(vrD2555.dat, 0, 6) = substr(rows_.dat, 0, 6)
                                                            then 1
                                                        else 0 end)
                                       else 1 end as out_weight_month,

                             sum(case
                                     when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat and
                                          substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4) then vrD2555.WAZN
                                     else 0 end)
                                 / case
                                       when sum(case
                                                    when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                         vrD2555.dat <= rows_.dat and
                                                         substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4) then 1
                                                    else 0 end) > 0
                                           then sum(case
                                                        when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                             vrD2555.dat <= rows_.dat and
                                                             substr(vrD2555.dat, 0, 4) = substr(rows_.dat, 0, 4)
                                                            then 1
                                                        else 0 end)
                                       else 1 end as out_weight_year,
--                        sum (case when vrD2555.SOURCE=rows_.source then )


                             sum(case
                                     when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat
                                         then vrD2555.WAZN
                                     else 0 end)
                                 / case
                                       when sum(case
                                                    when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat
                                                        then 1
                                                    else 0 end) > 0
                                           then sum(case
                                                        when vrD2555.SOURCE = rows_.source and
                                                             vrD2555.dat <= rows_.dat then 1
                                                        else 0 end)
                                       else 1 end -
                             sum(case
                                     when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat
                                         then vrD2555.WAZN
                                     else 0 end)
                                 / case
                                       when sum(case
                                                    when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat
                                                        then 1
                                                    else 0 end) > 0
                                           then sum(case
                                                        when vrD2555.SOURCE in (2320, 2340, 2555) and
                                                             vrD2555.dat <= rows_.dat then 1
                                                        else 0 end)
                                       else 1 end as remained_weight

                      from (
                               select dd.date__ as dat, ms.source as source, ms.material as material
                               from (
                                        select TO_CHAR(
                                                               (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                                                from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                                               'nls_calendar=persian') as date__
                                        from dual
                                        connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                                    from TBL_WARH_TOZIN t) +
                                                   LEVEL - 1 < CURRENT_DATE) dd,
                                    (select material, source
                                     from view_remittanceDetails2555
                                     where source not in (2320, 2340, 2555)
                                     group by material, source) ms
                               order by dd.date__ asc, ms.source, ms.material) rows_
                               left join view_remittanceDetails2555 vrD2555
                                         on rows_.material = vrD2555.material and vrD2555.dat <= rows_.dat
                                             and (
                                                    (rows_.source = vrD2555.source and vrD2555.target in (2320, 2340, 2555))
                                                    or
                                                    (vrD2555.source in (2320, 2340, 2555) and
                                                     vrD2555.inventory in (
                                                         select vrD25552.inventory
                                                         from view_remittanceDetails2555 vrD25552
                                                         where vrD25552.source = rows_.source
                                                           and vrD25552.dat <= rows_.dat
                                                           and vrD25552.material = rows_.material
                                                     ))
                                                )
--                 where rows_.dat=13981112 and rows_.MATERIAL=8
                      group by rows_.dat, rows_.source, rows_.material, vrD2555.TZNID
                      order by rows_.dat desc, rows_.source, rows_.material
                  ) vw
                      left join VIEW_REMITTANCE_PKG vrp
                                on vw.dat = vrp.DAT and vw.material = vrp.MATERIAL and vw.source = vrp.SOURCE
-- where material=8 and (income_weight_day>0 or out_weight_day>0)
             group by vw.dat, vw.source, vw.material
             order by vw.dat desc, vw.source, vw.material)
select vw01.dat,
       vw01.source,
       vw01.material,
       vw01.tadil,
       vw01.income_weight_day,
       vw01.income_weight_month,
       vw01.income_weight_year,
       vw01.out_weight_day,
       vw01.out_weight_month,
       vw01.out_weight_year,
       vw01.remained_weight + sum(vw02.tadil) as remained_weight

from vw0 vw01

         inner join vw0 vw02
                    on vw01.material = vw02.material and vw01.source = vw02.source and vw01.dat > vw02.dat
group by vw01.dat,
         vw01.source,
         vw01.material,
         vw01.tadil,
         vw01.income_weight_day,
         vw01.income_weight_month,
         vw01.income_weight_year,
         vw01.out_weight_day,
         vw01.out_weight_month,
         vw01.out_weight_year,
         vw01.remained_weight
order by  vw01.dat desc ,
          vw01.source,
          vw01.material





			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reaswwwdsssasdasytrdsza_0ssjjjsss05">
        <createView viewName="view_remittance_weight" replaceIfExists="true">
            <![CDATA[
with vw0 as (select vw.dat,
                    vw.source,
                    vw.material,
                    case when sum(vrp.REMAINED_PKG) = 0 then sum(0 - vw.remained_weight) else 0 end as tadil,
                    sum(vw.income_weight_day)                                                       as income_weight_day,
                    sum(vw.out_weight_day)                                                          as out_weight_day,
                    sum(vw.remained_weight)                                                         as remained_weight
             from (
                      select rows_.dat,
                             rows_.source,
                             rows_.material,
                             vrD2555.TZNID,
                             avg(case
                                     when vrD2555.SOURCE = rows_.source and vrD2555.dat = rows_.dat
                                         then vrD2555.WAZN
                                     else 0 end)
                                                 as income_weight_day,
                             avg(case
                                     when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat = rows_.dat
                                         then vrD2555.WAZN
                                     else 0 end) as out_weight_day,
                             avg(case
                                     when vrD2555.SOURCE = rows_.source and vrD2555.dat <= rows_.dat
                                         and vrD2555.DAT > rows_.pak0dat
                                         then vrD2555.WAZN
                                     else 0 end) -
                             avg(case
                                     when vrD2555.SOURCE in (2320, 2340, 2555) and vrD2555.dat <= rows_.dat
                                         and vrD2555.DAT > rows_.pak0dat
                                         then vrD2555.WAZN
                                     else 0 end) as remained_weight

                      from (
                               select vdsm.DAT, vdsm.SOURCE, vdsm.MATERIAL, nvl(max(vrp.DAT), 0) as pak0dat
                               from view_dat_source_material vdsm
                                        left join (select dat, material, source, REMAINED_PKG
                                                   from VIEW_REMITTANCE_PKG
                                                   where REMAINED_PKG = 0) vrp
                                                  on vdsm.source = vrp.SOURCE and vdsm.material = vrp.material and
                                                     vrp.DAT < vdsm.DAT
                               group by vdsm.DAT, vdsm.SOURCE, vdsm.MATERIAL
                           ) rows_
                               left join view_remittanceDetails2555 vrD2555
                                         on rows_.material = vrD2555.material and vrD2555.dat <= rows_.dat
                                             and (
                                                    (rows_.source = vrD2555.source and vrD2555.target in (2320, 2340, 2555))
                                                    or
                                                    (vrD2555.source in (2320, 2340, 2555) and
                                                     vrD2555.inventory in (
                                                         select vrD25552.inventory
                                                         from view_remittanceDetails2555 vrD25552
                                                         where vrD25552.source = rows_.source
                                                           and vrD25552.dat <= rows_.dat
                                                           and vrD25552.material = rows_.material
                                                     ))
                                                )
                      group by rows_.dat, rows_.source, rows_.material, vrD2555.TZNID
                      order by rows_.dat desc, rows_.source, rows_.material
                  ) vw
                      left join VIEW_REMITTANCE_PKG vrp
                                on vw.material = vrp.MATERIAL and vw.source = vrp.SOURCE
                                    and vw.dat = vrp.DAT
             group by vw.dat, vw.source, vw.material
             order by vw.dat desc, vw.source, vw.material)
select vw01.dat,
       vw01.source,
       vw01.material,
       vw01.tadil,
       sum(case when substr(vw01.dat, 0, 6) = substr(vw02.dat, 0, 6) then vw02.tadil else 0 end) as tadil_month,
       sum(case
               when substr(vw01.dat, 0, 4) = substr(vw02.dat, 0, 4) then vw02.tadil
               else 0 end) as                                                                       tadil_year,
       vw01.income_weight_day,
       sum(case
               when substr(vw01.dat, 0, 6) = substr(vw02.dat, 0, 6) then vw02.income_weight_day
               else 0 end) as                                                                       income_weight_month,
       sum(case
               when substr(vw01.dat, 0, 4) = substr(vw02.dat, 0, 4) then vw02.income_weight_day
               else 0 end) as                                                                       income_weight_year,
       vw01.out_weight_day,
       sum(case
               when substr(vw01.dat, 0, 6) = substr(vw02.dat, 0, 6) then vw02.out_weight_day
               else 0 end) as                                                                       out_weight_month,
       sum(case
               when substr(vw01.dat, 0, 4) = substr(vw02.dat, 0, 4) then vw02.out_weight_day
               else 0 end) as                                                                       out_weight_year,
       vw01.remained_weight
from vw0 vw01
         inner join vw0 vw02
                    on vw01.material = vw02.material and vw01.source = vw02.source and vw01.dat > vw02.dat
group by vw01.dat,
         vw01.source,
         vw01.material,
         vw01.tadil,
         vw01.income_weight_day,
         vw01.out_weight_day,
         vw01.remained_weight
order by vw01.dat desc,
         vw01.source,
         vw01.material



			]]>
        </createView>
    </changeSet>

    <!--    view_on_way_product-->

    <changeSet author="saebm" id="reaswwwdasdasdsza_0sssss05">
        <createView viewName="view_on_way_product" replaceIfExists="true">
            <![CDATA[
                                   select rows_.*,sum(owp.wazn) as owp_weight,sum(owp.tedad) as owp_pkg, count(owp.tozine_id) as owp_tozin
from (
         select dd.date__ as dat, ms.source as source, ms.material as material
         from (
                  select TO_CHAR(
                                         (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                          from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                         'nls_calendar=persian') as date__
                  from dual
                  connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                              from TBL_WARH_TOZIN t) +
                             LEVEL - 1 < CURRENT_DATE) dd,
              (select material, source
               from view_remittanceDetails2555
               where source not in (2320, 2340, 2555)
               group by material, source) ms
         order by dd.date__ asc, ms.source, ms.material) rows_

         left join (select
                           replace(sal_date2, '/', '') as sale_date,
                           gdscode,
                           tozine_id,
                           sourceid,
                           tedad,
                           wazn
                    from V_TOZINE_CONTENT_M
                    where sal_date2 is not null
                      and tozine_id not like '3-%'
                      and targetid in (2320, 2340, 2555)
                      and tozine_id not in (select TOZINE_ID from TBL_WARH_TOZIN)
                      and replace(sal_date2, '/', '') > (select min(dat) from TBL_WARH_TOZIN)

             ) owp
                   on rows_.dat = owp.sale_date and rows_.material = owp.gdscode and
                      rows_.source = owp.sourceid
group by rows_.dat,rows_.source,rows_.material
order by rows_.dat desc,rows_.source,rows_.material









			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reams05">
        <createView replaceIfExists="true" viewName="view_on_way_product_road_rail">
            <![CDATA[
                                 select DAT,
       MATERIAL,
       SOURCE,
       owp_day_arrived_tozin_rail,
       owp_day_not_arrived_tozin_rail,
       owp_day_arrived_weight_rail,
       owp_day_not_arrived_weight_rail,
       owp_day_arrived_tozin_road,
       owp_day_not_arrived_tozin_road,
       owp_day_arrived_weight_road,
       owp_day_not_arrived_weight_road,
       owp_total_not_arrived_weight_rail,
       owp_total_not_arrived_tozin_rail,
       owp_total_not_arrived_weight_road,
       owp_total_not_arrived_tozin_road,
       owp_month_arrived_tozin_rail,
       owp_month_not_arrived_tozin_rail,
       owp_month_arrived_weight_rail,
       owp_month_not_arrived_weight_rail,
       owp_month_arrived_tozin_road,
       owp_month_not_arrived_tozin_road,
       owp_month_arrived_weight_road,
       owp_month_not_arrived_weight_road,
       owp_year_arrived_tozin_rail,
       owp_year_not_arrived_tozin_rail,
       owp_year_arrived_weight_rail,
       owp_year_not_arrived_weight_rail,
       owp_year_arrived_tozin_road,
       owp_year_not_arrived_tozin_road,
       owp_year_arrived_weight_road,
       owp_year_not_arrived_weight_road
from (with tozin_daily as (
    select rows_.DAT,
           rows_.MATERIAL,
           rows_.SOURCE,
           sum(case
                   when
                           rows_.DAT = vtozin.dat and
                           vtozin.is_Rail = 1 and
                           vtozin.arrived_date is not null
                           and rows_.dat >= vtozin.arrived_date
                       then 1
                   else 0 end) as owp_day_arrived_tozin_rail,
           sum(case
                   when
                           rows_.DAT = vtozin.dat and
                           vtozin.is_Rail = 1 and
                           (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                   else 0 end) as owp_day_not_arrived_tozin_rail,
           sum(case
                   when
                           rows_.DAT = vtozin.dat and
                           vtozin.is_Rail = 1 and
                           vtozin.arrived_date is not null and rows_.dat >= vtozin.arrived_date
                       then vtozin.arrived_weight
                   else 0 end) as owp_day_arrived_weight_rail,
           sum(case
                   when rows_.DAT = vtozin.dat and
                        vtozin.is_Rail = 1 and
                        (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                       then vtozin.wazn
                   else 0 end) as owp_day_not_arrived_weight_rail,
           sum(case
                   when
                           rows_.DAT = vtozin.dat and
                           vtozin.is_Rail = 0 and
                           vtozin.arrived_date is not null
                           and rows_.dat >= vtozin.arrived_date
                       then 1
                   else 0 end) as owp_day_arrived_tozin_road,
           sum(case
                   when
                           rows_.DAT = vtozin.dat and
                           vtozin.is_Rail = 0 and
                           (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                   else 0 end) as owp_day_not_arrived_tozin_road,
           sum(case
                   when
                           rows_.DAT = vtozin.dat and
                           vtozin.is_Rail = 0 and
                           vtozin.arrived_date is not null and rows_.dat >= vtozin.arrived_date
                       then vtozin.arrived_weight
                   else 0 end) as owp_day_arrived_weight_road,
           sum(case
                   when rows_.DAT = vtozin.dat and
                        vtozin.is_Rail = 0 and
                        (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                       then vtozin.wazn
                   else 0 end) as owp_day_not_arrived_weight_road,
           sum(case
                   when
                           vtozin.is_Rail = 1 and
                           (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                       then vtozin.wazn
                   else 0 end) as owp_total_not_arrived_weight_rail,
           sum(case
                   when
                           vtozin.is_Rail = 1 and
                           (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                   else 0 end) as owp_total_not_arrived_tozin_rail,
           sum(case
                   when
                           vtozin.is_Rail = 0 and
                           (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                       then vtozin.wazn
                   else 0 end) as owp_total_not_arrived_weight_road,
           sum(case
                   when
                           vtozin.is_Rail = 0 and
                           (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                   else 0 end) as owp_total_not_arrived_tozin_road


    from view_dat_source_material rows_
             left join (
        select *
        from (
                 select replace(logistic.sal_date2, '/', '')                               as dat,
                        case when regexp_like(logistic.carno3, '[0-9]+') then 0 else 1 end as is_Rail,
                        logistic.gdscode                                                   as material,
                        logistic.sourceid                                                  as source,
                        logistic.targetid                                                  as target,
                        logistic.tedad                                                     as pkg,
                        logistic.wazn,
                        tzn.d_date                                                         as arrived_date,
                        tzn.d_wazn                                                         as arrived_weight
                 from v_tozine_content_m logistic
                          left join (select distinct stozin.ID        as s_id,
                                                     dtozin.ID        as t_id,
                                                     stozin.TOZINE_ID as s_tozine_id,
                                                     dtozin.TOZINE_ID as d_tozine_id,
                                                     stozin.dat       as s_date,
                                                     dtozin.dat       as d_date,
                                                     dtozin.WAZN      as d_wazn
                                     from TBL_WARH_REMITTANCE_DETAIL rd
                                              left join TBL_WARH_TOZIN dtozin on dtozin.ID = rd.F_DESTINATION_TOZINE_ID
                                              left join TBL_WARH_TOZIN stozin on stozin.ID = rd.F_SOURCE_TOZINE_ID
                                     where stozin.SOURCEID not in (2320, 2340, 2555)) tzn
                                    on
                                        logistic.tozine_id = tzn.s_tozine_id
                 where logistic.sal_date2 is not null
                   and replace(logistic.sal_date2, '/', '') > '13990000'
                   and logistic.tozine_id not like '3-%'
                   and logistic.targetid in (2320, 2340, 2555)
                 order by logistic.sal_date2 desc
             )) vtozin
                       on rows_.SOURCE = vtozin.source and rows_.MATERIAL = vtozin.material and
                          rows_.DAT >= vtozin.dat
    group by rows_.DAT, rows_.MATERIAL, rows_.SOURCE
    order by rows_.DAT desc, rows_.SOURCE, rows_.MATERIAL
)
      select tzn.DAT,
             tzn.MATERIAL,
             tzn.SOURCE,
             tzn.owp_day_arrived_tozin_rail,
             tzn.owp_day_not_arrived_tozin_rail,
             tzn.owp_day_arrived_weight_rail,
             tzn.owp_day_not_arrived_weight_rail,
             tzn.owp_day_arrived_tozin_road,
             tzn.owp_day_not_arrived_tozin_road,
             tzn.owp_day_arrived_weight_road,
             tzn.owp_day_not_arrived_weight_road,
             tzn.owp_total_not_arrived_weight_rail,
             tzn.owp_total_not_arrived_tozin_rail,
             tzn.owp_total_not_arrived_weight_road,
             tzn.owp_total_not_arrived_tozin_road,
             sum(case
                     when substr(tzn.dat, 0, 6) = substr(tzn_for_sum.dat, 0, 6)
                         then tzn_for_sum.owp_day_arrived_tozin_rail
                     else 0 end) as owp_month_arrived_tozin_rail,
             sum(case
                     when substr(tzn.dat, 0, 6) = substr(tzn_for_sum.dat, 0, 6)
                         then tzn_for_sum.owp_day_not_arrived_tozin_rail
                     else 0 end) as owp_month_not_arrived_tozin_rail,
             sum(case
                     when substr(tzn.dat, 0, 6) = substr(tzn_for_sum.dat, 0, 6)
                         then tzn_for_sum.owp_day_arrived_weight_rail
                     else 0 end) as owp_month_arrived_weight_rail,
             sum(case
                     when substr(tzn.dat, 0, 6) = substr(tzn_for_sum.dat, 0, 6)
                         then tzn_for_sum.owp_day_not_arrived_weight_rail
                     else 0 end) as owp_month_not_arrived_weight_rail,
             sum(case
                     when substr(tzn.dat, 0, 6) = substr(tzn_for_sum.dat, 0, 6)
                         then tzn_for_sum.owp_day_arrived_tozin_road
                     else 0 end) as owp_month_arrived_tozin_road,
             sum(case
                     when substr(tzn.dat, 0, 6) = substr(tzn_for_sum.dat, 0, 6)
                         then tzn_for_sum.owp_day_not_arrived_tozin_road
                     else 0 end) as owp_month_not_arrived_tozin_road,
             sum(case
                     when substr(tzn.dat, 0, 6) = substr(tzn_for_sum.dat, 0, 6)
                         then tzn_for_sum.owp_day_arrived_weight_road
                     else 0 end) as owp_month_arrived_weight_road,
             sum(case
                     when substr(tzn.dat, 0, 6) = substr(tzn_for_sum.dat, 0, 6)
                         then tzn_for_sum.owp_day_not_arrived_weight_road
                     else 0 end) as owp_month_not_arrived_weight_road,
-- YEAR
             sum(case
                     when substr(tzn.dat, 0, 4) = substr(tzn_for_sum.dat, 0, 4)
                         then tzn_for_sum.owp_day_arrived_tozin_rail
                     else 0 end) as owp_year_arrived_tozin_rail,
             sum(case
                     when substr(tzn.dat, 0, 4) = substr(tzn_for_sum.dat, 0, 4)
                         then tzn_for_sum.owp_day_not_arrived_tozin_rail
                     else 0 end) as owp_year_not_arrived_tozin_rail,
             sum(case
                     when substr(tzn.dat, 0, 4) = substr(tzn_for_sum.dat, 0, 4)
                         then tzn_for_sum.owp_day_arrived_weight_rail
                     else 0 end) as owp_year_arrived_weight_rail,
             sum(case
                     when substr(tzn.dat, 0, 4) = substr(tzn_for_sum.dat, 0, 4)
                         then tzn_for_sum.owp_day_not_arrived_weight_rail
                     else 0 end) as owp_year_not_arrived_weight_rail,
             sum(case
                     when substr(tzn.dat, 0, 4) = substr(tzn_for_sum.dat, 0, 4)
                         then tzn_for_sum.owp_day_arrived_tozin_road
                     else 0 end) as owp_year_arrived_tozin_road,
             sum(case
                     when substr(tzn.dat, 0, 4) = substr(tzn_for_sum.dat, 0, 4)
                         then tzn_for_sum.owp_day_not_arrived_tozin_road
                     else 0 end) as owp_year_not_arrived_tozin_road,
             sum(case
                     when substr(tzn.dat, 0, 4) = substr(tzn_for_sum.dat, 0, 4)
                         then tzn_for_sum.owp_day_arrived_weight_road
                     else 0 end) as owp_year_arrived_weight_road,
             sum(case
                     when substr(tzn.dat, 0, 4) = substr(tzn_for_sum.dat, 0, 4)
                         then tzn_for_sum.owp_day_not_arrived_weight_road
                     else 0 end) as owp_year_not_arrived_weight_road

      from tozin_daily tzn
               left join tozin_daily tzn_for_sum
                         on
                                 tzn.SOURCE = tzn_for_sum.SOURCE and
                                 tzn.MATERIAL = tzn_for_sum.MATERIAL and
                                 tzn.dat >= tzn_for_sum.DAT
      group by tzn.MATERIAL,
               tzn.SOURCE,
               tzn.DAT,
               tzn.owp_day_arrived_tozin_rail,
               tzn.owp_day_not_arrived_tozin_rail,
               tzn.owp_day_arrived_weight_rail,
               tzn.owp_day_not_arrived_weight_rail,
               tzn.owp_day_arrived_tozin_road,
               tzn.owp_day_not_arrived_tozin_road,
               tzn.owp_day_arrived_weight_road,
               tzn.owp_day_not_arrived_weight_road,
               tzn.owp_total_not_arrived_weight_rail,
               tzn.owp_total_not_arrived_tozin_rail,
               tzn.owp_total_not_arrived_weight_road,
               tzn.owp_total_not_arrived_tozin_road
      order by tzn.DAT desc,
               tzn.MATERIAL,
               tzn.SOURCE
     )










			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reams0d5">
        <sql>
            <![CDATA[
          CREATE OR REPLACE VIEW view_on_way_product_road_rail as                       select DAT,
       MATERIAL,
       SOURCE,
       owp_day_arrived_tozin_rail,
       owp_day_not_arrived_tozin_rail,
       owp_day_arrived_weight_rail,
       owp_day_not_arrived_weight_rail,
       owp_day_arrived_tozin_road,
       owp_day_not_arrived_tozin_road,
       owp_day_arrived_weight_road,
       owp_day_not_arrived_weight_road,
       owp_total_not_arrived_weight_rail,
       owp_total_not_arrived_tozin_rail,
       owp_total_not_arrived_weight_road,
       owp_total_not_arrived_tozin_road,
       owp_month_arrived_tozin_rail,
       owp_month_not_arrived_tozin_rail,
       owp_month_arrived_weight_rail,
       owp_month_not_arrived_weight_rail,
       owp_month_arrived_tozin_road,
       owp_month_not_arrived_tozin_road,
       owp_month_arrived_weight_road,
       owp_month_not_arrived_weight_road,
       owp_year_arrived_tozin_rail,
       owp_year_not_arrived_tozin_rail,
       owp_year_arrived_weight_rail,
       owp_year_not_arrived_weight_rail,
       owp_year_arrived_tozin_road,
       owp_year_not_arrived_tozin_road,
       owp_year_arrived_weight_road,
       owp_year_not_arrived_weight_road,
       owp_day_arrived_tozin_rail_all_material,
       owp_day_not_arrived_tozin_rail_all_material,
       owp_day_arrived_weight_rail_all_material,
       owp_day_not_arrived_weight_rail_all_material,
       owp_total_not_arrived_weight_rail_all_material,
       owp_total_not_arrived_tozin_rail_all_material,
       owp_month_arrived_tozin_rail_all_material,
       owp_month_not_arrived_tozin_rail_all_material,
       owp_month_arrived_weight_rail_all_material,
       owp_month_not_arrived_weight_rail_all_material,
       owp_year_arrived_tozin_rail_all_material,
       owp_year_not_arrived_tozin_rail_all_material,
       owp_year_arrived_weight_rail_all_material,
       owp_year_not_arrived_weight_rail_all_material,
       owp_day_arrived_tozin_road_all_material,
       owp_day_not_arrived_tozin_road_all_material,
       owp_day_arrived_weight_road_all_material,
       owp_day_not_arrived_weight_road_all_material,
       owp_total_not_arrived_weight_road_all_material,
       owp_total_not_arrived_tozin_road_all_material,
       owp_month_arrived_tozin_road_all_material,
       owp_month_not_arrived_tozin_road_all_material,
       owp_month_arrived_weight_road_all_material,
       owp_month_not_arrived_weight_road_all_material,
       owp_year_arrived_tozin_road_all_material,
       owp_year_not_arrived_tozin_road_all_material,
       owp_year_arrived_weight_road_all_material,
       owp_year_not_arrived_weight_road_all_material,
       owp_day_arrived_tozin_all_material,
       owp_day_not_arrived_tozin_all_material,
       owp_day_arrived_weight_all_material,
       owp_day_not_arrived_weight_all_material,
       owp_total_not_arrived_weight_all_material,
       owp_total_not_arrived_tozin_all_material,
       owp_month_arrived_tozin_all_material,
       owp_month_not_arrived_tozin_all_material,
       owp_month_arrived_weight_all_material,
       owp_month_not_arrived_weight_all_material,
       owp_year_arrived_tozin_all_material,
       owp_year_not_arrived_tozin_all_material,
       owp_year_arrived_weight_all_material,
       owp_year_not_arrived_weight_all_material,
       owp_total_not_arrived_weight,
       owp_total_not_arrived_tozin
from (
         with tozin_daily as (
             select rows_.DAT,

                    rows_.MATERIAL,

                    rows_.SOURCE,

                    sum(case
                            when
                                    rows_.DAT = vtozin.dat and
                                    vtozin.is_Rail = 1 and
                                    vtozin.arrived_date is not null
                                    and rows_.dat >= vtozin.arrived_date
                                then 1
                            else 0 end) as owp_day_arrived_tozin_rail,

                    sum(case
                            when
                                    rows_.DAT = vtozin.dat and
                                    vtozin.is_Rail = 1 and
                                    (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                            else 0 end) as owp_day_not_arrived_tozin_rail,

                    sum(case
                            when
                                    rows_.DAT = vtozin.dat and
                                    vtozin.is_Rail = 1 and
                                    vtozin.arrived_date is not null and rows_.dat >= vtozin.arrived_date
                                then vtozin.arrived_weight
                            else 0 end) as owp_day_arrived_weight_rail,

                    sum(case
                            when rows_.DAT = vtozin.dat and
                                 vtozin.is_Rail = 1 and
                                 (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                                then vtozin.wazn
                            else 0 end) as owp_day_not_arrived_weight_rail,

                    sum(case
                            when
                                    rows_.DAT = vtozin.dat and
                                    vtozin.is_Rail = 0 and
                                    vtozin.arrived_date is not null
                                    and rows_.dat >= vtozin.arrived_date
                                then 1
                            else 0 end) as owp_day_arrived_tozin_road,

                    sum(case
                            when
                                    rows_.DAT = vtozin.dat and
                                    vtozin.is_Rail = 0 and
                                    (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                            else 0 end) as owp_day_not_arrived_tozin_road,

                    sum(case
                            when
                                    rows_.DAT = vtozin.dat and
                                    vtozin.is_Rail = 0 and
                                    vtozin.arrived_date is not null and rows_.dat >= vtozin.arrived_date
                                then vtozin.arrived_weight
                            else 0 end) as owp_day_arrived_weight_road,

                    sum(case
                            when rows_.DAT = vtozin.dat and
                                 vtozin.is_Rail = 0 and
                                 (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                                then vtozin.wazn
                            else 0 end) as owp_day_not_arrived_weight_road,

                    sum(case
                            when
                                    vtozin.is_Rail = 1 and
                                    (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                                then vtozin.wazn
                            else 0 end) as owp_total_not_arrived_weight_rail,

                    sum(case
                            when
                                    vtozin.is_Rail = 1 and
                                    (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                            else 0 end) as owp_total_not_arrived_tozin_rail,

                    sum(case
                            when
                                    vtozin.is_Rail = 0 and
                                    (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                                then vtozin.wazn
                            else 0 end) as owp_total_not_arrived_weight_road,

                    sum(case
                            when
                                    vtozin.is_Rail = 0 and
                                    (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                            else 0 end) as owp_total_not_arrived_tozin_road


             from view_dat_source_material rows_
                      left join (
                 select *
                 from (
                          select replace(logistic.sal_date2,
                                         '/',
                                         '')       as dat,

                                 case
                                     when regexp_like(logistic.carno3,
                                                      '[0-9]+') then 0
                                     else 1 end    as is_Rail,

                                 logistic.gdscode  as material,

                                 logistic.sourceid as source,

                                 logistic.targetid as target,

                                 logistic.tedad    as pkg,

                                 logistic.wazn,

                                 tzn.d_date        as arrived_date,

                                 tzn.d_wazn        as arrived_weight
                          from v_tozine_content_m logistic
                                   left join (select distinct stozin.ID        as s_id,

                                                              dtozin.ID        as t_id,

                                                              stozin.TOZINE_ID as s_tozine_id,

                                                              dtozin.TOZINE_ID as d_tozine_id,

                                                              stozin.dat       as s_date,

                                                              dtozin.dat       as d_date,

                                                              dtozin.WAZN      as d_wazn
                                              from TBL_WARH_REMITTANCE_DETAIL rd
                                                       left join TBL_WARH_TOZIN dtozin on dtozin.ID = rd.F_DESTINATION_TOZINE_ID
                                                       left join TBL_WARH_TOZIN stozin on stozin.ID = rd.F_SOURCE_TOZINE_ID
                                              where stozin.SOURCEID not in (2320,
                                                                            2340,
                                                                            2555)) tzn
                                             on
                                                 logistic.tozine_id = tzn.s_tozine_id
                          where logistic.sal_date2 is not null
                            and replace(logistic.sal_date2,
                                        '/',
                                        '') > '13990000'
                            and logistic.tozine_id not like '3-%'
                            and logistic.targetid in (2320,
                                                      2340,
                                                      2555)
                          order by logistic.sal_date2 desc
                      )) vtozin
                                on rows_.SOURCE = vtozin.source and rows_.MATERIAL = vtozin.material and
                                   rows_.DAT >= vtozin.dat
             group by rows_.DAT,
                      rows_.MATERIAL,
                      rows_.SOURCE
             order by rows_.DAT desc,
                      rows_.SOURCE,
                      rows_.MATERIAL
         ),
              tozin_year as (
                  select tzn.DAT,

                         tzn.MATERIAL,

                         tzn.SOURCE,

                         tzn.owp_day_arrived_tozin_rail,

                         tzn.owp_day_not_arrived_tozin_rail,

                         tzn.owp_day_arrived_weight_rail,

                         tzn.owp_day_not_arrived_weight_rail,

                         tzn.owp_day_arrived_tozin_road,

                         tzn.owp_day_not_arrived_tozin_road,

                         tzn.owp_day_arrived_weight_road,

                         tzn.owp_day_not_arrived_weight_road,

                         tzn.owp_total_not_arrived_weight_rail,

                         tzn.owp_total_not_arrived_tozin_rail,

                         tzn.owp_total_not_arrived_weight_road,

                         tzn.owp_total_not_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_arrived_tozin_rail
                                 else 0 end) as owp_month_arrived_tozin_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_not_arrived_tozin_rail
                                 else 0 end) as owp_month_not_arrived_tozin_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_arrived_weight_rail
                                 else 0 end) as owp_month_arrived_weight_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_not_arrived_weight_rail
                                 else 0 end) as owp_month_not_arrived_weight_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_arrived_tozin_road
                                 else 0 end) as owp_month_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_not_arrived_tozin_road
                                 else 0 end) as owp_month_not_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_arrived_weight_road
                                 else 0 end) as owp_month_arrived_weight_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_not_arrived_weight_road
                                 else 0 end) as owp_month_not_arrived_weight_road,

-- YEAR
                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_arrived_tozin_rail
                                 else 0 end) as owp_year_arrived_tozin_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_not_arrived_tozin_rail
                                 else 0 end) as owp_year_not_arrived_tozin_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_arrived_weight_rail
                                 else 0 end) as owp_year_arrived_weight_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_not_arrived_weight_rail
                                 else 0 end) as owp_year_not_arrived_weight_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_arrived_tozin_road
                                 else 0 end) as owp_year_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_not_arrived_tozin_road
                                 else 0 end) as owp_year_not_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_arrived_weight_road
                                 else 0 end) as owp_year_arrived_weight_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_not_arrived_weight_road
                                 else 0 end) as owp_year_not_arrived_weight_road

                  from tozin_daily tzn
                           left join tozin_daily tzn_for_sum
                                     on
                                             tzn.SOURCE = tzn_for_sum.SOURCE and
                                             tzn.MATERIAL = tzn_for_sum.MATERIAL and
                                             tzn.dat >= tzn_for_sum.DAT
                  group by tzn.MATERIAL,
                           tzn.SOURCE,
                           tzn.DAT,
                           tzn.owp_day_arrived_tozin_rail,
                           tzn.owp_day_not_arrived_tozin_rail,
                           tzn.owp_day_arrived_weight_rail,
                           tzn.owp_day_not_arrived_weight_rail,
                           tzn.owp_day_arrived_tozin_road,
                           tzn.owp_day_not_arrived_tozin_road,
                           tzn.owp_day_arrived_weight_road,
                           tzn.owp_day_not_arrived_weight_road,
                           tzn.owp_total_not_arrived_weight_rail,
                           tzn.owp_total_not_arrived_tozin_rail,
                           tzn.owp_total_not_arrived_weight_road,
                           tzn.owp_total_not_arrived_tozin_road
                  order by tzn.DAT desc,
                           tzn.MATERIAL,
                           tzn.SOURCE
              )
         select tyear.DAT,
                tyear.MATERIAL,
                tyear.SOURCE,
                tyear.owp_day_arrived_tozin_rail,
                tyear.owp_day_not_arrived_tozin_rail,
                tyear.owp_day_arrived_weight_rail,
                tyear.owp_day_not_arrived_weight_rail,
                tyear.owp_day_arrived_tozin_road,
                tyear.owp_day_not_arrived_tozin_road,
                tyear.owp_day_arrived_weight_road,
                tyear.owp_day_not_arrived_weight_road,
                tyear.owp_total_not_arrived_weight_rail,
                tyear.owp_total_not_arrived_tozin_rail,
                tyear.owp_total_not_arrived_weight_road,
                tyear.owp_total_not_arrived_tozin_road,
                tyear.owp_month_arrived_tozin_rail,
                tyear.owp_month_not_arrived_tozin_rail,
                tyear.owp_month_arrived_weight_rail,
                tyear.owp_month_not_arrived_weight_rail,
                tyear.owp_month_arrived_tozin_road,
                tyear.owp_month_not_arrived_tozin_road,
                tyear.owp_month_arrived_weight_road,
                tyear.owp_month_not_arrived_weight_road,
                tyear.owp_year_arrived_tozin_rail,
                tyear.owp_year_not_arrived_tozin_rail,
                tyear.owp_year_arrived_weight_rail,
                tyear.owp_year_not_arrived_weight_rail,
                tyear.owp_year_arrived_tozin_road,
                tyear.owp_year_not_arrived_tozin_road,
                tyear.owp_year_arrived_weight_road,
                tyear.owp_year_not_arrived_weight_road,

--        All INCOME RAIL
                sum(tt.owp_day_arrived_tozin_rail)                                               as owp_day_arrived_tozin_rail_all_material,
                sum(tt.owp_day_not_arrived_tozin_rail)                                           as owp_day_not_arrived_tozin_rail_all_material,
                sum(tt.owp_day_arrived_weight_rail)                                              as owp_day_arrived_weight_rail_all_material,
                sum(tt.owp_day_not_arrived_weight_rail)                                          as owp_day_not_arrived_weight_rail_all_material,
                sum(tt.owp_total_not_arrived_weight_rail)                                        as owp_total_not_arrived_weight_rail_all_material,
                sum(tt.owp_total_not_arrived_tozin_rail)                                         as owp_total_not_arrived_tozin_rail_all_material,
                sum(tt.owp_month_arrived_tozin_rail)                                             as owp_month_arrived_tozin_rail_all_material,
                sum(tt.owp_month_not_arrived_tozin_rail)                                         as owp_month_not_arrived_tozin_rail_all_material,
                sum(tt.owp_month_arrived_weight_rail)                                            as owp_month_arrived_weight_rail_all_material,
                sum(tt.owp_month_not_arrived_weight_rail)                                        as owp_month_not_arrived_weight_rail_all_material,
                sum(tt.owp_year_arrived_tozin_rail)                                              as owp_year_arrived_tozin_rail_all_material,
                sum(tt.owp_year_not_arrived_tozin_rail)                                          as owp_year_not_arrived_tozin_rail_all_material,
                sum(tt.owp_year_arrived_weight_rail)                                             as owp_year_arrived_weight_rail_all_material,
                sum(tt.owp_year_not_arrived_weight_rail)                                         as owp_year_not_arrived_weight_rail_all_material,

                --ALL INCOME ROAD
                sum(tt.owp_day_arrived_tozin_road)                                               as owp_day_arrived_tozin_road_all_material,
                sum(tt.owp_day_not_arrived_tozin_road)                                           as owp_day_not_arrived_tozin_road_all_material,
                sum(tt.owp_day_arrived_weight_road)                                              as owp_day_arrived_weight_road_all_material,
                sum(tt.owp_day_not_arrived_weight_road)                                          as owp_day_not_arrived_weight_road_all_material,
                sum(tt.owp_total_not_arrived_weight_road)                                        as owp_total_not_arrived_weight_road_all_material,
                sum(tt.owp_total_not_arrived_tozin_road)                                         as owp_total_not_arrived_tozin_road_all_material,
                sum(tt.owp_month_arrived_tozin_road)                                             as owp_month_arrived_tozin_road_all_material,
                sum(tt.owp_month_not_arrived_tozin_road)                                         as owp_month_not_arrived_tozin_road_all_material,
                sum(tt.owp_month_arrived_weight_road)                                            as owp_month_arrived_weight_road_all_material,
                sum(tt.owp_month_not_arrived_weight_road)                                        as owp_month_not_arrived_weight_road_all_material,
                sum(tt.owp_year_arrived_tozin_road)                                              as owp_year_arrived_tozin_road_all_material,
                sum(tt.owp_year_not_arrived_tozin_road)                                          as owp_year_not_arrived_tozin_road_all_material,
                sum(tt.owp_year_arrived_weight_road)                                             as owp_year_arrived_weight_road_all_material,
                sum(tt.owp_year_not_arrived_weight_road)                                         as owp_year_not_arrived_weight_road_all_material,

-- ALL INCOME RAIL AND ROAD
                sum(tt.owp_day_arrived_tozin_road + tt.owp_day_arrived_tozin_road)               as owp_day_arrived_tozin_all_material,
                sum(
                        tt.owp_day_not_arrived_tozin_road + tt.owp_day_not_arrived_tozin_road)   as owp_day_not_arrived_tozin_all_material,
                sum(tt.owp_day_arrived_weight_road + tt.owp_day_arrived_weight_road)             as owp_day_arrived_weight_all_material,
                sum(
                        tt.owp_day_not_arrived_weight_road + tt.owp_day_not_arrived_weight_road) as owp_day_not_arrived_weight_all_material,
                sum(tt.owp_total_not_arrived_weight_road +
                    tt.owp_total_not_arrived_weight_road)                                        as owp_total_not_arrived_weight_all_material,
                sum(tt.owp_total_not_arrived_tozin_road +
                    tt.owp_total_not_arrived_tozin_road)                                         as owp_total_not_arrived_tozin_all_material,
                sum(
                        tt.owp_month_arrived_tozin_road + tt.owp_month_arrived_tozin_road)       as owp_month_arrived_tozin_all_material,
                sum(tt.owp_month_not_arrived_tozin_road +
                    tt.owp_month_not_arrived_tozin_road)                                         as owp_month_not_arrived_tozin_all_material,
                sum(
                        tt.owp_month_arrived_weight_road + tt.owp_month_arrived_weight_road)     as owp_month_arrived_weight_all_material,
                sum(tt.owp_month_not_arrived_weight_road +
                    tt.owp_month_not_arrived_weight_road)                                        as owp_month_not_arrived_weight_all_material,
                sum(tt.owp_year_arrived_tozin_road + tt.owp_year_arrived_tozin_road)             as owp_year_arrived_tozin_all_material,
                sum(
                        tt.owp_year_not_arrived_tozin_road + tt.owp_year_not_arrived_tozin_road) as owp_year_not_arrived_tozin_all_material,
                sum(
                        tt.owp_year_arrived_weight_road + tt.owp_year_arrived_weight_road)       as owp_year_arrived_weight_all_material,
                sum(tt.owp_year_not_arrived_weight_road +
                    tt.owp_year_not_arrived_weight_road)                                         as owp_year_not_arrived_weight_all_material,
-- ALL On Way Product
                sum(case
                        when tyear.MATERIAL = tt.MATERIAL then tt.owp_total_not_arrived_weight_rail +
                                                               tt.owp_total_not_arrived_weight_road
                        else 0 end)                                                              as owp_total_not_arrived_weight,
                sum(case
                        when tyear.MATERIAL = tt.MATERIAL then tt.owp_total_not_arrived_tozin_rail +
                                                               tt.owp_total_not_arrived_tozin_road
                        else 0 end)                                                              as owp_total_not_arrived_tozin
         from tozin_year tyear
                  left join tozin_year tt
                            on tyear.DAT = tt.DAT
         group by tyear.DAT,
                  tyear.MATERIAL,
                  tyear.SOURCE,
                  tyear.owp_day_arrived_tozin_rail,
                  tyear.owp_day_not_arrived_tozin_rail,
                  tyear.owp_day_arrived_weight_rail,
                  tyear.owp_day_not_arrived_weight_rail,
                  tyear.owp_day_arrived_tozin_road,
                  tyear.owp_day_not_arrived_tozin_road,
                  tyear.owp_day_arrived_weight_road,
                  tyear.owp_day_not_arrived_weight_road,
                  tyear.owp_total_not_arrived_weight_rail,
                  tyear.owp_total_not_arrived_tozin_rail,
                  tyear.owp_total_not_arrived_weight_road,
                  tyear.owp_total_not_arrived_tozin_road,
                  tyear.owp_month_arrived_tozin_rail,
                  tyear.owp_month_not_arrived_tozin_rail,
                  tyear.owp_month_arrived_weight_rail,
                  tyear.owp_month_not_arrived_weight_rail,
                  tyear.owp_month_arrived_tozin_road,
                  tyear.owp_month_not_arrived_tozin_road,
                  tyear.owp_month_arrived_weight_road,
                  tyear.owp_month_not_arrived_weight_road,
                  tyear.owp_year_arrived_tozin_rail,
                  tyear.owp_year_not_arrived_tozin_rail,
                  tyear.owp_year_arrived_weight_rail,
                  tyear.owp_year_not_arrived_weight_rail,
                  tyear.owp_year_arrived_tozin_road,
                  tyear.owp_year_not_arrived_tozin_road,
                  tyear.owp_year_arrived_weight_road,
                  tyear.owp_year_not_arrived_weight_road
     )
order by DAT desc,
         MATERIAL,
         SOURCE








			]]>
        </sql>
    </changeSet>
    <changeSet author="saebm" id="reamss0d5">
        <sql>
            <![CDATA[
          CREATE OR REPLACE VIEW view_on_way_product_road_rail as                       select DAT,
       MATERIAL,
       SOURCE,
       owp_day_arrived_tozin_rail,
       owp_day_not_arrived_tozin_rail,
       owp_day_arrived_weight_rail,
       owp_day_not_arrived_weight_rail,
       owp_day_arrived_tozin_road,
       owp_day_not_arrived_tozin_road,
       owp_day_arrived_weight_road,
       owp_day_not_arrived_weight_road,
       owp_total_not_arrived_weight_rail,
       owp_total_not_arrived_tozin_rail,
       owp_total_not_arrived_weight_road,
       owp_total_not_arrived_tozin_road,
       owp_month_arrived_tozin_rail,
       owp_month_not_arrived_tozin_rail,
       owp_month_arrived_weight_rail,
       owp_month_not_arrived_weight_rail,
       owp_month_arrived_tozin_road,
       owp_month_not_arrived_tozin_road,
       owp_month_arrived_weight_road,
       owp_month_not_arrived_weight_road,
       owp_year_arrived_tozin_rail,
       owp_year_not_arrived_tozin_rail,
       owp_year_arrived_weight_rail,
       owp_year_not_arrived_weight_rail,
       owp_year_arrived_tozin_road,
       owp_year_not_arrived_tozin_road,
       owp_year_arrived_weight_road,
       owp_year_not_arrived_weight_road,
       owp_day_arrived_tozin_rail_all_material,
       owp_day_not_arrived_tozin_rail_all_material,
       owp_day_arrived_weight_rail_all_material,
       owp_day_not_arrived_weight_rail_all_material,
       owp_total_not_arrived_weight_rail_all_material,
       owp_total_not_arrived_tozin_rail_all_material,
       owp_month_arrived_tozin_rail_all_material,
       owp_month_not_arrived_tozin_rail_all_material,
       owp_month_arrived_weight_rail_all_material,
       owp_month_not_arrived_weight_rail_all_material,
       owp_year_arrived_tozin_rail_all_material,
       owp_year_not_arrived_tozin_rail_all_material,
       owp_year_arrived_weight_rail_all_material,
       owp_year_not_arrived_weight_rail_all_material,
       owp_day_arrived_tozin_road_all_material,
       owp_day_not_arrived_tozin_road_all_material,
       owp_day_arrived_weight_road_all_material,
       owp_day_not_arrived_weight_road_all_material,
       owp_total_not_arrived_weight_road_all_material,
       owp_total_not_arrived_tozin_road_all_material,
       owp_month_arrived_tozin_road_all_material,
       owp_month_not_arrived_tozin_road_all_material,
       owp_month_arrived_weight_road_all_material,
       owp_month_not_arrived_weight_road_all_material,
       owp_year_arrived_tozin_road_all_material,
       owp_year_not_arrived_tozin_road_all_material,
       owp_year_arrived_weight_road_all_material,
       owp_year_not_arrived_weight_road_all_material,
       owp_day_arrived_tozin_all_material,
       owp_day_not_arrived_tozin_all_material,
       owp_day_arrived_weight_all_material,
       owp_day_not_arrived_weight_all_material,
       owp_total_not_arrived_weight_all_material,
       owp_total_not_arrived_tozin_all_material,
       owp_month_arrived_tozin_all_material,
       owp_month_not_arrived_tozin_all_material,
       owp_month_arrived_weight_all_material,
       owp_month_not_arrived_weight_all_material,
       owp_year_arrived_tozin_all_material,
       owp_year_not_arrived_tozin_all_material,
       owp_year_arrived_weight_all_material,
       owp_year_not_arrived_weight_all_material,
       owp_total_not_arrived_weight,
       owp_total_not_arrived_tozin
from (
         with tozin_daily as (
             select rows_.DAT,

                    rows_.MATERIAL,

                    rows_.SOURCE,

                    sum(case
                            when
                                        rows_.DAT = vtozin.dat and
                                        vtozin.is_Rail = 1 and
                                        vtozin.arrived_date is not null
                                    and rows_.dat >= vtozin.arrived_date
                                then 1
                            else 0 end) as owp_day_arrived_tozin_rail,

                    sum(case
                            when
                                        rows_.DAT = vtozin.dat and
                                        vtozin.is_Rail = 1 and
                                        (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                            else 0 end) as owp_day_not_arrived_tozin_rail,

                    sum(case
                            when
                                        rows_.DAT = vtozin.dat and
                                        vtozin.is_Rail = 1 and
                                        vtozin.arrived_date is not null and rows_.dat >= vtozin.arrived_date
                                then vtozin.arrived_weight
                            else 0 end) as owp_day_arrived_weight_rail,

                    sum(case
                            when rows_.DAT = vtozin.dat and
                                 vtozin.is_Rail = 1 and
                                 (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                                then vtozin.wazn
                            else 0 end) as owp_day_not_arrived_weight_rail,

                    sum(case
                            when
                                        rows_.DAT = vtozin.dat and
                                        vtozin.is_Rail = 0 and
                                        vtozin.arrived_date is not null
                                    and rows_.dat >= vtozin.arrived_date
                                then 1
                            else 0 end) as owp_day_arrived_tozin_road,

                    sum(case
                            when
                                        rows_.DAT = vtozin.dat and
                                        vtozin.is_Rail = 0 and
                                        (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                            else 0 end) as owp_day_not_arrived_tozin_road,

                    sum(case
                            when
                                        rows_.DAT = vtozin.dat and
                                        vtozin.is_Rail = 0 and
                                        vtozin.arrived_date is not null and rows_.dat >= vtozin.arrived_date
                                then vtozin.arrived_weight
                            else 0 end) as owp_day_arrived_weight_road,

                    sum(case
                            when rows_.DAT = vtozin.dat and
                                 vtozin.is_Rail = 0 and
                                 (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                                then vtozin.wazn
                            else 0 end) as owp_day_not_arrived_weight_road,

                    sum(case
                            when
                                        vtozin.is_Rail = 1 and
                                        (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                                then vtozin.wazn
                            else 0 end) as owp_total_not_arrived_weight_rail,

                    sum(case
                            when
                                        vtozin.is_Rail = 1 and
                                        (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                            else 0 end) as owp_total_not_arrived_tozin_rail,

                    sum(case
                            when
                                        vtozin.is_Rail = 0 and
                                        (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date)
                                then vtozin.wazn
                            else 0 end) as owp_total_not_arrived_weight_road,

                    sum(case
                            when
                                        vtozin.is_Rail = 0 and
                                        (vtozin.arrived_date is null or rows_.dat < vtozin.arrived_date) then 1
                            else 0 end) as owp_total_not_arrived_tozin_road


             from view_dat_source_material rows_
                      left join (
                 select *
                 from (
                          select replace(logistic.sal_date2,
                                         '/',
                                         '')       as dat,

                                 case
                                     when regexp_like(logistic.carno3,
                                                      '[0-9]+') then 0
                                     else 1 end    as is_Rail,

                                 logistic.gdscode  as material,

                                 logistic.sourceid as source,

                                 logistic.targetid as target,

                                 logistic.tedad    as pkg,

                                 logistic.wazn,

                                 tzn.d_date        as arrived_date,

                                 tzn.d_wazn        as arrived_weight
                          from v_tozine_content_m logistic
                                   left join (select distinct stozin.ID        as s_id,

                                                              dtozin.ID        as t_id,

                                                              stozin.TOZINE_ID as s_tozine_id,

                                                              dtozin.TOZINE_ID as d_tozine_id,

                                                              stozin.dat       as s_date,

                                                              dtozin.dat       as d_date,

                                                              dtozin.WAZN      as d_wazn
                                              from TBL_WARH_REMITTANCE_DETAIL rd
                                                       left join TBL_WARH_TOZIN dtozin on dtozin.ID = rd.F_DESTINATION_TOZINE_ID
                                                       left join TBL_WARH_TOZIN stozin on stozin.ID = rd.F_SOURCE_TOZINE_ID
                                              where stozin.SOURCEID not in (2320,
                                                                            2340,
                                                                            2555)) tzn
                                             on
                                                     logistic.tozine_id = tzn.s_tozine_id
                          where logistic.sal_date2 is not null
                            and replace(logistic.sal_date2,
                                        '/',
                                        '') > '13990000'
                            and logistic.tozine_id not like '3-%'
                            and logistic.targetid in (2320,
                                                      2340,
                                                      2555)
                          order by logistic.sal_date2 desc
                      )) vtozin
                                on rows_.SOURCE = vtozin.source and rows_.MATERIAL = vtozin.material and
                                   rows_.DAT >= vtozin.dat
             group by rows_.DAT,
                      rows_.MATERIAL,
                      rows_.SOURCE
             order by rows_.DAT desc,
                      rows_.SOURCE,
                      rows_.MATERIAL
         ),
              tozin_year as (
                  select tzn.DAT,

                         tzn.MATERIAL,

                         tzn.SOURCE,

                         tzn.owp_day_arrived_tozin_rail,

                         tzn.owp_day_not_arrived_tozin_rail,

                         tzn.owp_day_arrived_weight_rail,

                         tzn.owp_day_not_arrived_weight_rail,

                         tzn.owp_day_arrived_tozin_road,

                         tzn.owp_day_not_arrived_tozin_road,

                         tzn.owp_day_arrived_weight_road,

                         tzn.owp_day_not_arrived_weight_road,

                         tzn.owp_total_not_arrived_weight_rail,

                         tzn.owp_total_not_arrived_tozin_rail,

                         tzn.owp_total_not_arrived_weight_road,

                         tzn.owp_total_not_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_arrived_tozin_rail
                                 else 0 end) as owp_month_arrived_tozin_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_not_arrived_tozin_rail
                                 else 0 end) as owp_month_not_arrived_tozin_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_arrived_weight_rail
                                 else 0 end) as owp_month_arrived_weight_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_not_arrived_weight_rail
                                 else 0 end) as owp_month_not_arrived_weight_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_arrived_tozin_road
                                 else 0 end) as owp_month_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_not_arrived_tozin_road
                                 else 0 end) as owp_month_not_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_arrived_weight_road
                                 else 0 end) as owp_month_arrived_weight_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             6) = substr(tzn_for_sum.dat,
                                                         0,
                                                         6)
                                     then tzn_for_sum.owp_day_not_arrived_weight_road
                                 else 0 end) as owp_month_not_arrived_weight_road,

-- YEAR
                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_arrived_tozin_rail
                                 else 0 end) as owp_year_arrived_tozin_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_not_arrived_tozin_rail
                                 else 0 end) as owp_year_not_arrived_tozin_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_arrived_weight_rail
                                 else 0 end) as owp_year_arrived_weight_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_not_arrived_weight_rail
                                 else 0 end) as owp_year_not_arrived_weight_rail,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_arrived_tozin_road
                                 else 0 end) as owp_year_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_not_arrived_tozin_road
                                 else 0 end) as owp_year_not_arrived_tozin_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_arrived_weight_road
                                 else 0 end) as owp_year_arrived_weight_road,

                         sum(case
                                 when substr(tzn.dat,
                                             0,
                                             4) = substr(tzn_for_sum.dat,
                                                         0,
                                                         4)
                                     then tzn_for_sum.owp_day_not_arrived_weight_road
                                 else 0 end) as owp_year_not_arrived_weight_road

                  from tozin_daily tzn
                           left join tozin_daily tzn_for_sum
                                     on
                                                 tzn.SOURCE = tzn_for_sum.SOURCE and
                                                 tzn.MATERIAL = tzn_for_sum.MATERIAL and
                                                 tzn.dat >= tzn_for_sum.DAT
                  group by tzn.MATERIAL,
                           tzn.SOURCE,
                           tzn.DAT,
                           tzn.owp_day_arrived_tozin_rail,
                           tzn.owp_day_not_arrived_tozin_rail,
                           tzn.owp_day_arrived_weight_rail,
                           tzn.owp_day_not_arrived_weight_rail,
                           tzn.owp_day_arrived_tozin_road,
                           tzn.owp_day_not_arrived_tozin_road,
                           tzn.owp_day_arrived_weight_road,
                           tzn.owp_day_not_arrived_weight_road,
                           tzn.owp_total_not_arrived_weight_rail,
                           tzn.owp_total_not_arrived_tozin_rail,
                           tzn.owp_total_not_arrived_weight_road,
                           tzn.owp_total_not_arrived_tozin_road
                  order by tzn.DAT desc,
                           tzn.MATERIAL,
                           tzn.SOURCE
              )
         select tyear.DAT,
                tyear.MATERIAL,
                tyear.SOURCE,
                tyear.owp_day_arrived_tozin_rail,
                tyear.owp_day_not_arrived_tozin_rail,
                tyear.owp_day_arrived_weight_rail,
                tyear.owp_day_not_arrived_weight_rail,
                tyear.owp_day_arrived_tozin_road,
                tyear.owp_day_not_arrived_tozin_road,
                tyear.owp_day_arrived_weight_road,
                tyear.owp_day_not_arrived_weight_road,
                tyear.owp_total_not_arrived_weight_rail,
                tyear.owp_total_not_arrived_tozin_rail,
                tyear.owp_total_not_arrived_weight_road,
                tyear.owp_total_not_arrived_tozin_road,
                tyear.owp_month_arrived_tozin_rail,
                tyear.owp_month_not_arrived_tozin_rail,
                tyear.owp_month_arrived_weight_rail,
                tyear.owp_month_not_arrived_weight_rail,
                tyear.owp_month_arrived_tozin_road,
                tyear.owp_month_not_arrived_tozin_road,
                tyear.owp_month_arrived_weight_road,
                tyear.owp_month_not_arrived_weight_road,
                tyear.owp_year_arrived_tozin_rail,
                tyear.owp_year_not_arrived_tozin_rail,
                tyear.owp_year_arrived_weight_rail,
                tyear.owp_year_not_arrived_weight_rail,
                tyear.owp_year_arrived_tozin_road,
                tyear.owp_year_not_arrived_tozin_road,
                tyear.owp_year_arrived_weight_road,
                tyear.owp_year_not_arrived_weight_road,

--        All INCOME RAIL
                sum(tt.owp_day_arrived_tozin_rail)                                               as owp_day_arrived_tozin_rail_all_material,
                sum(tt.owp_day_not_arrived_tozin_rail)                                           as owp_day_not_arrived_tozin_rail_all_material,
                sum(tt.owp_day_arrived_weight_rail)                                              as owp_day_arrived_weight_rail_all_material,
                sum(tt.owp_day_not_arrived_weight_rail)                                          as owp_day_not_arrived_weight_rail_all_material,
                sum(tt.owp_total_not_arrived_weight_rail)                                        as owp_total_not_arrived_weight_rail_all_material,
                sum(tt.owp_total_not_arrived_tozin_rail)                                         as owp_total_not_arrived_tozin_rail_all_material,
                sum(tt.owp_month_arrived_tozin_rail)                                             as owp_month_arrived_tozin_rail_all_material,
                sum(tt.owp_month_not_arrived_tozin_rail)                                         as owp_month_not_arrived_tozin_rail_all_material,
                sum(tt.owp_month_arrived_weight_rail)                                            as owp_month_arrived_weight_rail_all_material,
                sum(tt.owp_month_not_arrived_weight_rail)                                        as owp_month_not_arrived_weight_rail_all_material,
                sum(tt.owp_year_arrived_tozin_rail)                                              as owp_year_arrived_tozin_rail_all_material,
                sum(tt.owp_year_not_arrived_tozin_rail)                                          as owp_year_not_arrived_tozin_rail_all_material,
                sum(tt.owp_year_arrived_weight_rail)                                             as owp_year_arrived_weight_rail_all_material,
                sum(tt.owp_year_not_arrived_weight_rail)                                         as owp_year_not_arrived_weight_rail_all_material,

                --ALL INCOME ROAD
                sum(tt.owp_day_arrived_tozin_road)                                               as owp_day_arrived_tozin_road_all_material,
                sum(tt.owp_day_not_arrived_tozin_road)                                           as owp_day_not_arrived_tozin_road_all_material,
                sum(tt.owp_day_arrived_weight_road)                                              as owp_day_arrived_weight_road_all_material,
                sum(tt.owp_day_not_arrived_weight_road)                                          as owp_day_not_arrived_weight_road_all_material,
                sum(tt.owp_total_not_arrived_weight_road)                                        as owp_total_not_arrived_weight_road_all_material,
                sum(tt.owp_total_not_arrived_tozin_road)                                         as owp_total_not_arrived_tozin_road_all_material,
                sum(tt.owp_month_arrived_tozin_road)                                             as owp_month_arrived_tozin_road_all_material,
                sum(tt.owp_month_not_arrived_tozin_road)                                         as owp_month_not_arrived_tozin_road_all_material,
                sum(tt.owp_month_arrived_weight_road)                                            as owp_month_arrived_weight_road_all_material,
                sum(tt.owp_month_not_arrived_weight_road)                                        as owp_month_not_arrived_weight_road_all_material,
                sum(tt.owp_year_arrived_tozin_road)                                              as owp_year_arrived_tozin_road_all_material,
                sum(tt.owp_year_not_arrived_tozin_road)                                          as owp_year_not_arrived_tozin_road_all_material,
                sum(tt.owp_year_arrived_weight_road)                                             as owp_year_arrived_weight_road_all_material,
                sum(tt.owp_year_not_arrived_weight_road)                                         as owp_year_not_arrived_weight_road_all_material,

-- ALL INCOME RAIL AND ROAD
                sum(tt.owp_day_arrived_tozin_road + tt.owp_day_arrived_tozin_rail)               as owp_day_arrived_tozin_all_material,
                sum(
                            tt.owp_day_not_arrived_tozin_road + tt.owp_day_not_arrived_tozin_rail)   as owp_day_not_arrived_tozin_all_material,
                sum(tt.owp_day_arrived_weight_road + tt.owp_day_arrived_weight_rail)             as owp_day_arrived_weight_all_material,
                sum(
                            tt.owp_day_not_arrived_weight_road + tt.owp_day_not_arrived_weight_rail) as owp_day_not_arrived_weight_all_material,
                sum(tt.owp_total_not_arrived_weight_road +
                    tt.owp_total_not_arrived_weight_rail)                                        as owp_total_not_arrived_weight_all_material,
                sum(tt.owp_total_not_arrived_tozin_road +
                    tt.owp_total_not_arrived_tozin_rail)                                         as owp_total_not_arrived_tozin_all_material,
                sum(
                            tt.owp_month_arrived_tozin_road + tt.owp_month_arrived_tozin_rail)       as owp_month_arrived_tozin_all_material,
                sum(tt.owp_month_not_arrived_tozin_road +
                    tt.owp_month_not_arrived_tozin_rail)                                         as owp_month_not_arrived_tozin_all_material,
                sum(
                            tt.owp_month_arrived_weight_road + tt.owp_month_arrived_weight_rail)     as owp_month_arrived_weight_all_material,
                sum(tt.owp_month_not_arrived_weight_road +
                    tt.owp_month_not_arrived_weight_rail)                                        as owp_month_not_arrived_weight_all_material,
                sum(tt.owp_year_arrived_tozin_road + tt.owp_year_arrived_tozin_rail)             as owp_year_arrived_tozin_all_material,
                sum(
                            tt.owp_year_not_arrived_tozin_road + tt.owp_year_not_arrived_tozin_rail) as owp_year_not_arrived_tozin_all_material,
                sum(
                            tt.owp_year_arrived_weight_road + tt.owp_year_arrived_weight_rail)       as owp_year_arrived_weight_all_material,
                sum(tt.owp_year_not_arrived_weight_road +
                    tt.owp_year_not_arrived_weight_rail)                                         as owp_year_not_arrived_weight_all_material,
-- ALL On Way Product
                sum(case
                        when tyear.MATERIAL = tt.MATERIAL then tt.owp_total_not_arrived_weight_rail +
                                                               tt.owp_total_not_arrived_weight_road
                        else 0 end)                                                              as owp_total_not_arrived_weight,
                sum(case
                        when tyear.MATERIAL = tt.MATERIAL then tt.owp_total_not_arrived_tozin_rail +
                                                               tt.owp_total_not_arrived_tozin_road
                        else 0 end)                                                              as owp_total_not_arrived_tozin
         from tozin_year tyear
                  left join tozin_year tt
                            on tyear.DAT = tt.DAT
         group by tyear.DAT,
                  tyear.MATERIAL,
                  tyear.SOURCE,
                  tyear.owp_day_arrived_tozin_rail,
                  tyear.owp_day_not_arrived_tozin_rail,
                  tyear.owp_day_arrived_weight_rail,
                  tyear.owp_day_not_arrived_weight_rail,
                  tyear.owp_day_arrived_tozin_road,
                  tyear.owp_day_not_arrived_tozin_road,
                  tyear.owp_day_arrived_weight_road,
                  tyear.owp_day_not_arrived_weight_road,
                  tyear.owp_total_not_arrived_weight_rail,
                  tyear.owp_total_not_arrived_tozin_rail,
                  tyear.owp_total_not_arrived_weight_road,
                  tyear.owp_total_not_arrived_tozin_road,
                  tyear.owp_month_arrived_tozin_rail,
                  tyear.owp_month_not_arrived_tozin_rail,
                  tyear.owp_month_arrived_weight_rail,
                  tyear.owp_month_not_arrived_weight_rail,
                  tyear.owp_month_arrived_tozin_road,
                  tyear.owp_month_not_arrived_tozin_road,
                  tyear.owp_month_arrived_weight_road,
                  tyear.owp_month_not_arrived_weight_road,
                  tyear.owp_year_arrived_tozin_rail,
                  tyear.owp_year_not_arrived_tozin_rail,
                  tyear.owp_year_arrived_weight_rail,
                  tyear.owp_year_not_arrived_weight_rail,
                  tyear.owp_year_arrived_tozin_road,
                  tyear.owp_year_not_arrived_tozin_road,
                  tyear.owp_year_arrived_weight_road,
                  tyear.owp_year_not_arrived_weight_road
     )
order by DAT desc,
         MATERIAL,
         SOURCE





			]]>
        </sql>
    </changeSet>


    <!--    view_daily_report_sum_source-->
    <changeSet author="saebm" id="reaswwwdkasdasadsza_0ssjjjsss05">
        <createView viewName="view_daily_report_sum_source" replaceIfExists="true">
            <![CDATA[




select
    rows_.dat, rows_.material,
sum(IN_PKG_DAY) as sum_IN_PKG_DAY,
sum( IN_PKG_MONTH) as sum_IN_PKG_MONTH,
sum( IN_PKG_YEAR) as sum_IN_PKG_YEAR,
sum( IN_AMOUNT_DAY) as sum_IN_AMOUNT_DAY,
sum( IN_AMOUNT_MONTH) as sum_IN_AMOUNT_MONTH,
sum( IN_AMOUNT_YEAR) as sum_IN_AMOUNT_YEAR,
sum( OUT_PKG_DAY) as sum_OUT_PKG_DAY,
sum( OUT_PKG_MONTH) as sum_OUT_PKG_MONTH,
sum( OUT_PKG_YEAR) as sum_OUT_PKG_YEAR,
sum( OUT_AMOUNT_DAY) as sum_OUT_AMOUNT_DAY,
sum( OUT_AMOUNT_MONTH) as sum_OUT_AMOUNT_MONTH,
sum( OUT_AMOUNT_YEAR) as sum_OUT_AMOUNT_YEAR,
sum( REMAINED_PKG) as sum_REMAINED_PKG,
sum( REMAINED_AMOUNT) as sum_REMAINED_AMOUNT,
sum( INCOME_WEIGHT_DAY) as sum_INCOME_WEIGHT_DAY,
sum( INCOME_WEIGHT_MONTH) as sum_INCOME_WEIGHT_MONTH,
sum( INCOME_WEIGHT_YEAR) as sum_INCOME_WEIGHT_YEAR,
sum( OUT_WEIGHT_DAY) as sum_OUT_WEIGHT_DAY,
sum( OUT_WEIGHT_MONTH) as sum_OUT_WEIGHT_MONTH,
sum( OUT_WEIGHT_YEAR) as sum_OUT_WEIGHT_YEAR,
sum( REMAINED_WEIGHT) as sum_REMAINED_WEIGHT,
sum( vrw.tadil) as sum_tadil,
sum( OWP_WEIGHT) as sum_OWP_WEIGHT,
sum( OWP_PKG) as sum_OWP_PKG,
sum( OWP_TOZIN) as sum_OWP_TOZIN,
sum(TADIL_MONTH) as sum_TADIL_MONTH,
sum(TADIL_YEAR) as sum_TADIL_YEAR,
sum(TADIL_YEAR)/case when sum(OUT_WEIGHT_YEAR)>0 then sum(OUT_WEIGHT_YEAR) else 1 end as sum_tadil_year_percent
from VIEW_DAT_SOURCE_MATERIAL rows_
         left join TBL_MATERIAL_ITEM tmi on rows_.MATERIAL=tmi.ID
         left join TBL_MATERIAL tm on tmi.MATERIAL_ID = tm.ID
         left join VIEW_REMITTANCE_PKG vrp
                   on
                               rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
         left join VIEW_ON_WAY_PRODUCT VOWP on
            rows_.dat=VOWP.DAT and rows_.source=VOWP.SOURCE and rows_.material=VOWP.MATERIAL
         left join VIEW_REMITTANCE_WEIGHT vrw on
            rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
         left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
         left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
group by rows_.dat, rows_.material
order by rows_.dat desc,rows_.material





			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reaswjjjsss05">
        <createView viewName="view_daily_report_sum_source" replaceIfExists="true">
            <![CDATA[
select
    rows_.dat, rows_.material,
    sum(IN_PKG_DAY) as sum_IN_PKG_DAY,
    sum( IN_PKG_MONTH) as sum_IN_PKG_MONTH,
    sum( IN_PKG_YEAR) as sum_IN_PKG_YEAR,
    sum( IN_AMOUNT_DAY) as sum_IN_AMOUNT_DAY,
    sum( IN_AMOUNT_MONTH) as sum_IN_AMOUNT_MONTH,
    sum( IN_AMOUNT_YEAR) as sum_IN_AMOUNT_YEAR,
    sum( OUT_PKG_DAY) as sum_OUT_PKG_DAY,
    sum( OUT_PKG_MONTH) as sum_OUT_PKG_MONTH,
    sum( OUT_PKG_YEAR) as sum_OUT_PKG_YEAR,
    sum( OUT_AMOUNT_DAY) as sum_OUT_AMOUNT_DAY,
    sum( OUT_AMOUNT_MONTH) as sum_OUT_AMOUNT_MONTH,
    sum( OUT_AMOUNT_YEAR) as sum_OUT_AMOUNT_YEAR,
    sum( REMAINED_PKG) as sum_REMAINED_PKG,
    sum( REMAINED_AMOUNT) as sum_REMAINED_AMOUNT,
    sum( INCOME_WEIGHT_DAY) as sum_INCOME_WEIGHT_DAY,
    sum( INCOME_WEIGHT_MONTH) as sum_INCOME_WEIGHT_MONTH,
    sum( INCOME_WEIGHT_YEAR) as sum_INCOME_WEIGHT_YEAR,
    sum( OUT_WEIGHT_DAY) as sum_OUT_WEIGHT_DAY,
    sum( OUT_WEIGHT_MONTH) as sum_OUT_WEIGHT_MONTH,
    sum( OUT_WEIGHT_YEAR) as sum_OUT_WEIGHT_YEAR,
    sum( REMAINED_WEIGHT) as sum_REMAINED_WEIGHT,
    sum( vrw.tadil) as sum_tadil,
    sum(TADIL_MONTH) as sum_TADIL_MONTH,
    sum(TADIL_YEAR) as sum_TADIL_YEAR,
    sum(TADIL_YEAR)/case when sum(OUT_WEIGHT_YEAR)>0 then sum(OUT_WEIGHT_YEAR) else 1 end as sum_tadil_year_percent
from VIEW_DAT_SOURCE_MATERIAL rows_
         left join TBL_MATERIAL_ITEM tmi on rows_.MATERIAL=tmi.ID
         left join TBL_MATERIAL tm on tmi.MATERIAL_ID = tm.ID
         left join VIEW_REMITTANCE_PKG vrp
                   on
                               rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
         left join VIEW_REMITTANCE_WEIGHT vrw on
            rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
         left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
         left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
group by rows_.dat, rows_.material
order by rows_.dat desc,rows_.material



			]]>
        </createView>
    </changeSet>

    <!--    view_daily_report2555-->

    <changeSet author="saebm" id="reaswwwdasdasdsza_0ssjjjsss05">
        <createView viewName="view_daily_report2555" replaceIfExists="true">
            <![CDATA[


select
rows_.dat, rows_.source, rows_.material,wh.C_NAME as source_name,mi.GDSNAME as material_name,
       IN_PKG_DAY, IN_PKG_MONTH, IN_PKG_YEAR, IN_AMOUNT_DAY, IN_AMOUNT_MONTH, IN_AMOUNT_YEAR, OUT_PKG_DAY, OUT_PKG_MONTH, OUT_PKG_YEAR, OUT_AMOUNT_DAY, OUT_AMOUNT_MONTH, OUT_AMOUNT_YEAR, REMAINED_PKG, REMAINED_AMOUNT,
       INCOME_WEIGHT_DAY, INCOME_WEIGHT_MONTH, INCOME_WEIGHT_YEAR, OUT_WEIGHT_DAY, OUT_WEIGHT_MONTH, OUT_WEIGHT_YEAR, REMAINED_WEIGHT,
        OWP_WEIGHT, OWP_PKG, OWP_TOZIN
from (
         select dd.date__ as dat, ms.source as source, ms.material as material
         from (
                  select TO_CHAR(
                                         (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                          from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                         'nls_calendar=persian') as date__
                  from dual
                  connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                              from TBL_WARH_TOZIN t) +
                             LEVEL - 1 < CURRENT_DATE) dd,
              (select material, source
               from view_remittanceDetails2555
               where source not in (2320, 2340, 2555)
               group by material, source) ms
         order by dd.date__ asc, ms.source, ms.material) rows_

         left join VIEW_REMITTANCE_PKG vrp
on
    rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
left join VIEW_ON_WAY_PRODUCT VOWP on
rows_.dat=VOWP.DAT and rows_.source=VOWP.SOURCE and rows_.material=VOWP.MATERIAL
left join VIEW_REMITTANCE_WEIGHT vrw on
rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
order by rows_.dat desc,rows_.source,rows_.material








			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reaswwwdasdasdssssssza_0ssjjjsss05">
        <createView viewName="view_daily_report2555" replaceIfExists="true">
            <![CDATA[


select
rows_.dat, rows_.source, rows_.material,wh.C_NAME as source_name,mi.GDSNAME as material_name,
       IN_PKG_DAY, IN_PKG_MONTH, IN_PKG_YEAR, IN_AMOUNT_DAY, IN_AMOUNT_MONTH, IN_AMOUNT_YEAR, OUT_PKG_DAY, OUT_PKG_MONTH, OUT_PKG_YEAR, OUT_AMOUNT_DAY, OUT_AMOUNT_MONTH, OUT_AMOUNT_YEAR, REMAINED_PKG, REMAINED_AMOUNT,
       INCOME_WEIGHT_DAY, INCOME_WEIGHT_MONTH, INCOME_WEIGHT_YEAR, OUT_WEIGHT_DAY, OUT_WEIGHT_MONTH, OUT_WEIGHT_YEAR, REMAINED_WEIGHT,
       vrw.tadil, OWP_WEIGHT, OWP_PKG, OWP_TOZIN
from (
         select dd.date__ as dat, ms.source as source, ms.material as material
         from (
                  select TO_CHAR(
                                         (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                                          from TBL_WARH_TOZIN t) + LEVEL - 1, 'yyyymmdd',
                                         'nls_calendar=persian') as date__
                  from dual
                  connect by (select min(TO_DATE(t.dat, 'yyyymmdd', 'nls_calendar=persian'))
                              from TBL_WARH_TOZIN t) +
                             LEVEL - 1 < CURRENT_DATE) dd,
              (select material, source
               from view_remittanceDetails2555
               where source not in (2320, 2340, 2555)
               group by material, source) ms
         order by dd.date__ asc, ms.source, ms.material) rows_

         left join VIEW_REMITTANCE_PKG vrp
on
    rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
left join VIEW_ON_WAY_PRODUCT VOWP on
rows_.dat=VOWP.DAT and rows_.source=VOWP.SOURCE and rows_.material=VOWP.MATERIAL
left join VIEW_REMITTANCE_WEIGHT vrw on
rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
order by rows_.dat desc,rows_.source,rows_.material








			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reaswwwdasdasdssssssaza_0ssjjjsss05">
        <createView viewName="view_daily_report2555" replaceIfExists="true">
            <![CDATA[


select
    rows_.dat, rows_.source, rows_.material,wh.C_NAME as source_name,mi.GDSNAME as material_name,
    IN_PKG_DAY, IN_PKG_MONTH, IN_PKG_YEAR, IN_AMOUNT_DAY, IN_AMOUNT_MONTH, IN_AMOUNT_YEAR, OUT_PKG_DAY, OUT_PKG_MONTH, OUT_PKG_YEAR, OUT_AMOUNT_DAY, OUT_AMOUNT_MONTH, OUT_AMOUNT_YEAR, REMAINED_PKG, REMAINED_AMOUNT,
    INCOME_WEIGHT_DAY, INCOME_WEIGHT_MONTH, INCOME_WEIGHT_YEAR, OUT_WEIGHT_DAY, OUT_WEIGHT_MONTH, OUT_WEIGHT_YEAR, REMAINED_WEIGHT,
    vrw.tadil, OWP_WEIGHT, OWP_PKG, OWP_TOZIN,tm.ID as materialp,tm.C_DESC_FA as materialpname
from VIEW_DAT_SOURCE_MATERIAL rows_
        left join TBL_MATERIAL_ITEM tmi on rows_.MATERIAL=tmi.ID
        left join TBL_MATERIAL tm on tmi.MATERIAL_ID = tm.ID
         left join VIEW_REMITTANCE_PKG vrp
                   on
                               rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
         left join VIEW_ON_WAY_PRODUCT VOWP on
            rows_.dat=VOWP.DAT and rows_.source=VOWP.SOURCE and rows_.material=VOWP.MATERIAL
         left join VIEW_REMITTANCE_WEIGHT vrw on
            rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
         left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
         left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
order by rows_.dat desc,rows_.source,rows_.material










			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reaswwwdasdasssssdsstadilza_0ssjjjsss05">
        <createView viewName="view_daily_report2555" replaceIfExists="true">
            <![CDATA[

select
    rows_.dat,rows_.unit, rows_.source, rows_.material,wh.C_NAME as source_name,mi.GDSNAME as material_name,
    IN_PKG_DAY, IN_PKG_MONTH, IN_PKG_YEAR, IN_AMOUNT_DAY, IN_AMOUNT_MONTH, IN_AMOUNT_YEAR, OUT_PKG_DAY, OUT_PKG_MONTH, OUT_PKG_YEAR, OUT_AMOUNT_DAY, OUT_AMOUNT_MONTH, OUT_AMOUNT_YEAR, REMAINED_PKG, REMAINED_AMOUNT,
    INCOME_WEIGHT_DAY, INCOME_WEIGHT_MONTH, INCOME_WEIGHT_YEAR, OUT_WEIGHT_DAY, OUT_WEIGHT_MONTH, OUT_WEIGHT_YEAR, REMAINED_WEIGHT,
    vrw.tadil, OWP_WEIGHT, OWP_PKG, OWP_TOZIN,tm.ID as materialp,tm.C_DESC_FA as materialpname,TADIL_MONTH,TADIL_YEAR,
    TADIL_YEAR/case when OUT_WEIGHT_YEAR>0 then OUT_WEIGHT_YEAR else 1 end as tadil_year_percent
from VIEW_DAT_SOURCE_MATERIAL rows_
        left join TBL_MATERIAL_ITEM tmi on rows_.MATERIAL=tmi.ID
        left join TBL_MATERIAL tm on tmi.MATERIAL_ID = tm.ID
         left join VIEW_REMITTANCE_PKG vrp
                   on
                               rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
         left join VIEW_ON_WAY_PRODUCT VOWP on
            rows_.dat=VOWP.DAT and rows_.source=VOWP.SOURCE and rows_.material=VOWP.MATERIAL
         left join VIEW_REMITTANCE_WEIGHT vrw on
            rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
         left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
         left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
order by rows_.dat desc,rows_.source,rows_.material








			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reaslsssdsstadilza_0ssjjjsss05">
        <createView viewName="view_daily_report2555" replaceIfExists="true">
            <![CDATA[
select
    rows_.dat, rows_.material,
    sum(IN_PKG_DAY) as sum_IN_PKG_DAY,
    sum( IN_PKG_MONTH) as sum_IN_PKG_MONTH,
    sum( IN_PKG_YEAR) as sum_IN_PKG_YEAR,
    sum( IN_AMOUNT_DAY) as sum_IN_AMOUNT_DAY,
    sum( IN_AMOUNT_MONTH) as sum_IN_AMOUNT_MONTH,
    sum( IN_AMOUNT_YEAR) as sum_IN_AMOUNT_YEAR,
    sum( OUT_PKG_DAY) as sum_OUT_PKG_DAY,
    sum( OUT_PKG_MONTH) as sum_OUT_PKG_MONTH,
    sum( OUT_PKG_YEAR) as sum_OUT_PKG_YEAR,
    sum( OUT_AMOUNT_DAY) as sum_OUT_AMOUNT_DAY,
    sum( OUT_AMOUNT_MONTH) as sum_OUT_AMOUNT_MONTH,
    sum( OUT_AMOUNT_YEAR) as sum_OUT_AMOUNT_YEAR,
    sum( REMAINED_PKG) as sum_REMAINED_PKG,
    sum( REMAINED_AMOUNT) as sum_REMAINED_AMOUNT,
    sum( INCOME_WEIGHT_DAY) as sum_INCOME_WEIGHT_DAY,
    sum( INCOME_WEIGHT_MONTH) as sum_INCOME_WEIGHT_MONTH,
    sum( INCOME_WEIGHT_YEAR) as sum_INCOME_WEIGHT_YEAR,
    sum( OUT_WEIGHT_DAY) as sum_OUT_WEIGHT_DAY,
    sum( OUT_WEIGHT_MONTH) as sum_OUT_WEIGHT_MONTH,
    sum( OUT_WEIGHT_YEAR) as sum_OUT_WEIGHT_YEAR,
    sum( REMAINED_WEIGHT) as sum_REMAINED_WEIGHT,
    sum( vrw.tadil) as sum_tadil,
    sum( OWP_WEIGHT) as sum_OWP_WEIGHT,
    sum( OWP_PKG) as sum_OWP_PKG,
    sum( OWP_TOZIN) as sum_OWP_TOZIN,
    sum(TADIL_MONTH) as sum_TADIL_MONTH,
    sum(TADIL_YEAR) as sum_TADIL_YEAR,
    sum(TADIL_YEAR)/case when sum(OUT_WEIGHT_YEAR)>0 then sum(OUT_WEIGHT_YEAR) else 1 end as sum_tadil_year_percent
from VIEW_DAT_SOURCE_MATERIAL rows_
         left join TBL_MATERIAL_ITEM tmi on rows_.MATERIAL=tmi.ID
         left join TBL_MATERIAL tm on tmi.MATERIAL_ID = tm.ID
         left join VIEW_REMITTANCE_PKG vrp
                   on
                               rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
         left join VIEW_ON_WAY_PRODUCT VOWP on
            rows_.dat=VOWP.DAT and rows_.source=VOWP.SOURCE and rows_.material=VOWP.MATERIAL
         left join VIEW_REMITTANCE_WEIGHT vrw on
            rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
         left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
         left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
group by rows_.dat, rows_.material
order by rows_.dat desc,rows_.material

			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reasls9s05">
        <createView viewName="view_daily_report2555" replaceIfExists="true">
            <![CDATA[

select
    rows_.dat,
rows_.unit,
 rows_.source,
 rows_.material,
wh.C_NAME as source_name,
mi.GDSNAME as material_name,

    IN_PKG_DAY,
 IN_PKG_MONTH,
 IN_PKG_YEAR,
 IN_AMOUNT_DAY,
 IN_AMOUNT_MONTH,
 IN_AMOUNT_YEAR,
 OUT_PKG_DAY,
 OUT_PKG_MONTH,
 OUT_PKG_YEAR,
 OUT_AMOUNT_DAY,
 OUT_AMOUNT_MONTH,
 OUT_AMOUNT_YEAR,
 REMAINED_PKG,
 REMAINED_AMOUNT,

    INCOME_WEIGHT_DAY,
 INCOME_WEIGHT_MONTH,
 INCOME_WEIGHT_YEAR,
 OUT_WEIGHT_DAY,
 OUT_WEIGHT_MONTH,
 OUT_WEIGHT_YEAR,
 REMAINED_WEIGHT,

    vrw.tadil,
 OWP_WEIGHT,
 OWP_PKG,
 OWP_TOZIN,
tm.ID as materialp,
tm.C_DESC_FA as materialpname,
TADIL_MONTH,
TADIL_YEAR,
    TADIL_YEAR/case when OUT_WEIGHT_YEAR>0 then OUT_WEIGHT_YEAR else 1 end as tadil_year_percent,
    sum_.sum_IN_PKG_DAY,
    sum_.sum_IN_PKG_MONTH,
    sum_.sum_IN_PKG_YEAR,
    sum_.sum_IN_AMOUNT_DAY,
    sum_.sum_IN_AMOUNT_MONTH,
    sum_.sum_IN_AMOUNT_YEAR,
    sum_.sum_OUT_PKG_DAY,
    sum_.sum_OUT_PKG_MONTH,
    sum_.sum_OUT_PKG_YEAR,
    sum_.sum_OUT_AMOUNT_DAY,
    sum_.sum_OUT_AMOUNT_MONTH,
    sum_.sum_OUT_AMOUNT_YEAR,
    sum_.sum_REMAINED_PKG,
    sum_.sum_REMAINED_AMOUNT,
    sum_.sum_INCOME_WEIGHT_DAY,
    sum_.sum_INCOME_WEIGHT_MONTH,
    sum_.sum_INCOME_WEIGHT_YEAR,
    sum_.sum_OUT_WEIGHT_DAY,
    sum_.sum_OUT_WEIGHT_MONTH,
    sum_.sum_OUT_WEIGHT_YEAR,
    sum_.sum_REMAINED_WEIGHT,
    sum_.sum_tadil,
    sum_.sum_TADIL_MONTH,
    sum_.sum_TADIL_YEAR,
    sum_.sum_tadil_year_percent
from VIEW_DAT_SOURCE_MATERIAL rows_
         left join TBL_MATERIAL_ITEM tmi on rows_.MATERIAL=tmi.ID
         left join TBL_MATERIAL tm on tmi.MATERIAL_ID = tm.ID
         left join VIEW_REMITTANCE_PKG vrp
                   on
                               rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
         left join VIEW_ON_WAY_PRODUCT VOWP on
            rows_.dat=VOWP.DAT and rows_.source=VOWP.SOURCE and rows_.material=VOWP.MATERIAL
         left join VIEW_REMITTANCE_WEIGHT vrw on
            rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
         left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
         left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
         left join view_daily_report_sum_source sum_
                   on rows_.dat = sum_.dat and rows_.material=sum_.material
order by rows_.dat desc,rows_.source,rows_.material



			]]>
        </createView>
    </changeSet>
    <changeSet author="saebm" id="reassls9s05">
        <createView viewName="view_daily_report2555" replaceIfExists="true">
            <![CDATA[

select
    rows_.dat,
    rows_.unit,
    rows_.source,
    rows_.material,
    wh.C_NAME as source_name,
    mi.GDSNAME as material_name,
    owp_day_arrived_tozin_rail,
    owp_day_not_arrived_tozin_rail,
    owp_day_arrived_weight_rail,
    owp_day_not_arrived_weight_rail,
    owp_day_arrived_tozin_road,
    owp_day_not_arrived_tozin_road,
    owp_day_arrived_weight_road,
    owp_day_not_arrived_weight_road,
    owp_total_not_arrived_weight_rail,
    owp_total_not_arrived_tozin_rail,
    owp_total_not_arrived_weight_road,
    owp_total_not_arrived_tozin_road,
    owp_month_arrived_tozin_rail,
    owp_month_not_arrived_tozin_rail,
    owp_month_arrived_weight_rail,
    owp_month_not_arrived_weight_rail,
    owp_month_arrived_tozin_road,
    owp_month_not_arrived_tozin_road,
    owp_month_arrived_weight_road,
    owp_month_not_arrived_weight_road,
    owp_year_arrived_tozin_rail,
    owp_year_not_arrived_tozin_rail,
    owp_year_arrived_weight_rail,
    owp_year_not_arrived_weight_rail,
    owp_year_arrived_tozin_road,
    owp_year_not_arrived_tozin_road,
    owp_year_arrived_weight_road,
    owp_year_not_arrived_weight_road,
    owp_day_arrived_tozin_rail_all_material,
    owp_day_not_arrived_tozin_rail_all_material,
    owp_day_arrived_weight_rail_all_material,
    owp_day_not_arrived_weight_rail_all_material,
    owp_total_not_arrived_weight_rail_all_material,
    owp_total_not_arrived_tozin_rail_all_material,
    owp_month_arrived_tozin_rail_all_material,
    owp_month_not_arrived_tozin_rail_all_material,
    owp_month_arrived_weight_rail_all_material,
    owp_month_not_arrived_weight_rail_all_material,
    owp_year_arrived_tozin_rail_all_material,
    owp_year_not_arrived_tozin_rail_all_material,
    owp_year_arrived_weight_rail_all_material,
    owp_year_not_arrived_weight_rail_all_material,
    owp_day_arrived_tozin_road_all_material,
    owp_day_not_arrived_tozin_road_all_material,
    owp_day_arrived_weight_road_all_material,
    owp_day_not_arrived_weight_road_all_material,
    owp_total_not_arrived_weight_road_all_material,
    owp_total_not_arrived_tozin_road_all_material,
    owp_month_arrived_tozin_road_all_material,
    owp_month_not_arrived_tozin_road_all_material,
    owp_month_arrived_weight_road_all_material,
    owp_month_not_arrived_weight_road_all_material,
    owp_year_arrived_tozin_road_all_material,
    owp_year_not_arrived_tozin_road_all_material,
    owp_year_arrived_weight_road_all_material,
    owp_year_not_arrived_weight_road_all_material,
    owp_day_arrived_tozin_all_material,
    owp_day_not_arrived_tozin_all_material,
    owp_day_arrived_weight_all_material,
    owp_day_not_arrived_weight_all_material,
    owp_total_not_arrived_weight_all_material,
    owp_total_not_arrived_tozin_all_material,
    owp_month_arrived_tozin_all_material,
    owp_month_not_arrived_tozin_all_material,
    owp_month_arrived_weight_all_material,
    owp_month_not_arrived_weight_all_material,
    owp_year_arrived_tozin_all_material,
    owp_year_not_arrived_tozin_all_material,
    owp_year_arrived_weight_all_material,
    owp_year_not_arrived_weight_all_material,
    owp_total_not_arrived_weight,
    owp_total_not_arrived_tozin,
    IN_PKG_DAY,
    IN_PKG_MONTH,
    IN_PKG_YEAR,
    IN_AMOUNT_DAY,
    IN_AMOUNT_MONTH,
    IN_AMOUNT_YEAR,
    OUT_PKG_DAY,
    OUT_PKG_MONTH,
    OUT_PKG_YEAR,
    OUT_AMOUNT_DAY,
    OUT_AMOUNT_MONTH,
    OUT_AMOUNT_YEAR,
    REMAINED_PKG,
    REMAINED_AMOUNT,
    INCOME_WEIGHT_DAY,
    INCOME_WEIGHT_MONTH,
    INCOME_WEIGHT_YEAR,
    OUT_WEIGHT_DAY,
    OUT_WEIGHT_MONTH,
    OUT_WEIGHT_YEAR,
    REMAINED_WEIGHT,
    vrw.tadil,
    tm.ID as materialp,
    tm.C_DESC_FA as materialpname,
    TADIL_MONTH,
    TADIL_YEAR,
    TADIL_YEAR/case when OUT_WEIGHT_YEAR>0 then OUT_WEIGHT_YEAR else 1 end as tadil_year_percent,
    sum_.sum_IN_PKG_DAY,
    sum_.sum_IN_PKG_MONTH,
    sum_.sum_IN_PKG_YEAR,
    sum_.sum_IN_AMOUNT_DAY,
    sum_.sum_IN_AMOUNT_MONTH,
    sum_.sum_IN_AMOUNT_YEAR,
    sum_.sum_OUT_PKG_DAY,
    sum_.sum_OUT_PKG_MONTH,
    sum_.sum_OUT_PKG_YEAR,
    sum_.sum_OUT_AMOUNT_DAY,
    sum_.sum_OUT_AMOUNT_MONTH,
    sum_.sum_OUT_AMOUNT_YEAR,
    sum_.sum_REMAINED_PKG,
    sum_.sum_REMAINED_AMOUNT,
    sum_.sum_INCOME_WEIGHT_DAY,
    sum_.sum_INCOME_WEIGHT_MONTH,
    sum_.sum_INCOME_WEIGHT_YEAR,
    sum_.sum_OUT_WEIGHT_DAY,
    sum_.sum_OUT_WEIGHT_MONTH,
    sum_.sum_OUT_WEIGHT_YEAR,
    sum_.sum_REMAINED_WEIGHT,
    sum_.sum_tadil,
    sum_.sum_TADIL_MONTH,
    sum_.sum_TADIL_YEAR,
    sum_.sum_tadil_year_percent
from VIEW_DAT_SOURCE_MATERIAL rows_
         left join TBL_MATERIAL_ITEM tmi on rows_.MATERIAL=tmi.ID
         left join TBL_MATERIAL tm on tmi.MATERIAL_ID = tm.ID
         left join VIEW_REMITTANCE_PKG vrp
                   on
                               rows_.material=vrp.MATERIAL and rows_.source=vrp.SOURCE and rows_.dat=vrp.DAT
         left join VIEW_REMITTANCE_WEIGHT vrw on
            rows_.dat=vrw.DAT and rows_.source=vrw.SOURCE and rows_.material=vrw.MATERIAL
         left join TBL_WARH_WAREHOUSE wh on rows_.source=wh.id
         left join TBL_MATERIAL_ITEM mi on rows_.material=mi.ID
         left join view_daily_report_sum_source sum_
                   on rows_.dat = sum_.dat and rows_.material=sum_.material
        left join VIEW_ON_WAY_PRODUCT_ROAD_RAIL vowprr on rows_.MATERIAL=vowprr.MATERIAL
                                                        and rows_.SOURCE=vowprr.SOURCE
                                                        and rows_.DAT=vowprr.DAT
order by rows_.dat desc,rows_.source,rows_.material



			]]>
        </createView>
    </changeSet>


</databaseChangeLog>
